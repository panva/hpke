<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="description" content="HPKE demo and RFC test vector validation for all KEM, KDF, and AEAD implementations in your browser. Try hybrid public key encryption and cryptography suites interactively." />
    <title>HPKE Demo & Test Suite | Hybrid Public Key Encryption</title>
    <link rel="canonical" href="https://github.com/panva/hpke" />
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="HPKE Demo & Test Suite" />
    <meta property="og:description" content="HPKE demo and RFC test vector validation for all KEM, KDF, and AEAD implementations in your browser." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://github.com/panva/hpke" />
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HPKE Demo & Test Suite" />
    <meta name="twitter:description" content="HPKE demo and RFC test vector validation for all KEM, KDF, and AEAD implementations in your browser." />
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "HPKE Demo & Test Suite",
      "url": "https://github.com/panva/hpke",
      "description": "HPKE demo and RFC test vector validation for all KEM, KDF, and AEAD implementations in your browser.",
      "applicationCategory": "DeveloperTool",
      "operatingSystem": "Web",
      "author": {
        "@type": "Person",
        "name": "Filip Skokan"
      }
    }
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23fbbf24'/><stop offset='100%25' style='stop-color:%2360a5fa'/></linearGradient></defs><rect x='25' y='45' width='50' height='40' fill='url(%23g)' rx='5'/><path d='M 35 45 L 35 30 A 15 15 0 0 1 65 30 L 65 45' fill='none' stroke='url(%23g)' stroke-width='8'/></svg>">
    <script type="importmap">
      {
        "imports": {
          "@panva/hpke": "./index.js",
          "@panva/hpke-noble": "./examples/noble-suite/index.js",
          "@noble/": "./node_modules/@noble/",
          "./index.ts": "./index.js",
          "bowser": "https://cdn.jsdelivr.net/npm/bowser@2/+esm"
        }
      }
    </script>
    <style>
      /* ============================================
         CSS Custom Properties (Design System)
         ============================================ */
      :root {
        /* Colors - Background */
        --color-bg-primary: #1d1e26;
        --color-bg-secondary: #282a36;
        --color-bg-tertiary: #333447;

        /* Colors - Text */
        --color-text-primary: #f8f8f2;
        --color-text-secondary: #a599e9;
        --color-text-tertiary: #8b82d9;

        /* Colors - Border */
        --color-border-primary: #333447;
        --color-border-secondary: #282a36;

        /* Colors - Semantic */
        --color-success: #5af78e;
        --color-success-hover: #4ae57e;
        --color-success-text: #5af78e;

        --color-error: #ff5c57;
        --color-error-bg: rgba(255, 92, 87, 0.15);
        --color-error-text: #ff6e6a;

        --color-warning: #f3f99d;
        --color-warning-bg: rgba(243, 249, 157, 0.15);

        --color-info: #a599e9;
        --color-info-bg: rgba(165, 153, 233, 0.1);

        /* Spacing */
        --space-xs: 4px;
        --space-sm: 8px;
        --space-md: 12px;
        --space-lg: 16px;
        --space-xl: 20px;
        --space-2xl: 30px;
        --space-3xl: 50px;

        /* Typography */
        --font-mono: 'Monaco', 'Courier New', monospace;
        --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;

        --font-size-xs: 10px;
        --font-size-sm: 11px;
        --font-size-base: 12px;
        --font-size-md: 13px;
        --font-size-lg: 14px;
        --font-size-xl: 16px;
        --font-size-2xl: 18px;
        --font-size-3xl: 24px;
        --font-size-4xl: 32px;

        /* Line Heights */
        --line-height-tight: 1;
        --line-height-base: 18px;
        --line-height-relaxed: 1.5;

        /* Transitions */
        --transition-fast: 0.15s ease;
        --transition-base: 0.2s ease;
        --transition-slow: 0.3s ease;

        /* Shadows */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);

        /* Border Radius */
        --radius-sm: 3px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-full: 50%;
      }

      /* ============================================
         CSS Reset & Base Styles
         ============================================ */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      .hidden {
        display: none !important;
      }

      body {
        font-family: var(--font-sans);
        padding: var(--space-xl);
        background: var(--color-bg-primary);
        min-height: 100vh;
        color: var(--color-text-primary);
        line-height: var(--line-height-relaxed);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ============================================
         Layout Components
         ============================================ */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--color-bg-secondary);
        box-shadow: var(--shadow-lg);
        padding: var(--space-2xl);
        border-radius: var(--radius-md);
      }

      /* ============================================
         Header Section
         ============================================ */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
        gap: var(--space-xl);
        position: relative;
      }

      .header > div:first-child {
        display: flex;
        align-items: center;
        gap: var(--space-md);
      }

      h1 {
        color: var(--color-text-primary);
        margin: 0;
        font-size: var(--font-size-4xl);
        line-height: var(--line-height-tight);
        font-weight: 700;
      }

      .subtitle {
        color: var(--color-text-secondary);
        margin-bottom: var(--space-2xl);
        font-size: var(--font-size-xl);
        line-height: var(--line-height-relaxed);
      }

      /* ============================================
         Social Links
         ============================================ */
      .social-links {
        display: flex;
        gap: var(--space-lg);
        align-items: center;
      }

      .social-links a {
        color: var(--color-text-primary);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: color var(--transition-base);
      }

      .social-links a:hover,
      .social-links a:focus {
        color: var(--color-info);
        outline: none;
      }

      .social-links a svg {
        width: 24px;
        height: 24px;
      }

      /* ============================================
         Filter Navigation
         ============================================ */
      .filter-links {
        display: flex;
        gap: var(--space-md);
        font-size: var(--font-size-md);
        flex-shrink: 0;
      }

      .filter-links a {
        color: var(--color-text-secondary);
        text-decoration: none;
        padding: var(--space-sm) var(--space-md);
        border: 2px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        transition: all var(--transition-base);
        white-space: nowrap;
        font-family: var(--font-mono);
        font-weight: 500;
      }

      .filter-links a:hover,
      .filter-links a:focus {
        color: var(--color-text-primary);
        transform: translateY(-2px);
        outline: none;
      }

      .filter-links a.active {
        color: var(--color-text-primary);
        border-color: var(--color-info);
        background: var(--color-info-bg);
      }

      /* ============================================
         Burger Menu (Mobile)
         ============================================ */
      .burger-menu {
        display: none;
        flex-direction: column;
        gap: var(--space-xs);
        cursor: pointer;
        padding: var(--space-sm);
        border: 2px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        background: transparent;
        transition: all var(--transition-base);
      }

      .burger-menu:hover,
      .burger-menu:focus {
        border-color: var(--color-info);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
        outline: none;
      }

      .burger-menu span {
        width: 20px;
        height: 2px;
        background: var(--color-text-secondary);
        transition: all var(--transition-base);
        border-radius: 1px;
      }

      .burger-menu:hover span,
      .burger-menu:focus span {
        background: var(--color-info);
      }

      /* ============================================
         Section Components
         ============================================ */
      .components-section,
      .vector-validation,
      .demo-section {
        margin-top: var(--space-3xl);
        padding: var(--space-2xl) var(--space-xl) var(--space-xl);
        background: var(--color-bg-primary);
        border: 2px solid var(--color-border-primary);
        border-radius: var(--radius-md);
        position: relative;
      }

      .section-label {
        position: absolute;
        top: -26px;
        left: 50%;
        transform: translateX(-50%);
        padding: var(--space-xs) var(--space-sm);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        background: var(--color-bg-primary);
        border: 2px solid var(--color-border-primary);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .download-vector-btn {
        position: absolute;
        top: -21px;
        right: var(--space-md);
        padding: var(--space-xs) var(--space-md);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        background: var(--color-bg-primary);
        border: 2px solid var(--color-border-primary);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        z-index: 1;
        line-height: 1;
      }

      .download-vector-btn:hover:not(:disabled) {
        color: var(--color-text-primary);
        border-top-color: var(--color-text-tertiary);
        background: var(--color-bg-primary);
      }

      .download-vector-btn:disabled {
        display: none;
      }

      /* ============================================
         Legend Component
         ============================================ */
      .legend {
        display: flex;
        gap: var(--space-xl);
        margin-top: var(--space-xl);
        margin-bottom: 0;
        padding: var(--space-md);
        background: var(--color-bg-secondary);
        border-radius: var(--radius-sm);
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        transition: all var(--transition-base);
      }

      .legend-item a {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        color: var(--color-text-secondary);
        text-decoration: none;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .legend-item a:hover,
      .legend-item a:focus {
        color: var(--color-text-primary);
        outline: none;
      }

      .legend-item.disabled {
        opacity: 0.5;
      }

      .legend-item.disabled span {
        text-decoration: line-through;
        color: var(--color-text-tertiary);
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border: 2px solid;
        border-radius: 2px;
      }

      .legend-color.supported {
        background: rgba(90, 247, 142, 0.15);
        border-color: var(--color-success);
      }

      .legend-color.unsupported {
        background: var(--color-error-bg);
        border-color: var(--color-error);
      }

      /* ============================================
         Algorithm Selector (Dropdowns)
         ============================================ */
      .algorithm-selector {
        display: flex;
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
      }

      .algo-select-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        flex: 1;
        min-width: 200px;
      }

      .algo-select-group label {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .algo-select-group label .pkg-name {
        text-transform: none;
        color: var(--color-text-tertiary);
        font-weight: 400;
      }

      .algo-select-wrapper {
        position: relative;
      }

      .algo-select {
        width: 100%;
        padding: var(--space-sm) var(--space-lg) var(--space-sm) var(--space-sm);
        background: var(--color-bg-secondary);
        border: 2px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-md);
        cursor: pointer;
        appearance: none;
        transition: all var(--transition-base);
      }

      .algo-select:hover {
        border-color: var(--color-text-tertiary);
      }

      .algo-select:focus {
        outline: none;
        border-color: var(--color-text-tertiary);
      }

      .algo-select-wrapper::after {
        content: '▼';
        position: absolute;
        right: var(--space-sm);
        top: 50%;
        transform: translateY(-50%);
        font-size: var(--font-size-xs);
        color: var(--color-text-secondary);
        pointer-events: none;
      }

      .algo-select option {
        background: var(--color-bg-secondary);
        color: var(--color-text-primary);
        padding: var(--space-sm);
      }

      .algo-select option:disabled {
        color: var(--color-text-tertiary);
      }

      /* ============================================
         IKM Section (Key Derivation)
         ============================================ */
      .ikm-section {
        margin-bottom: var(--space-lg);
        padding: var(--space-lg);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .ikm-section .demo-input-group {
        margin-bottom: 0;
      }

      /* ============================================
         Demo Layout Sections
         ============================================ */
      .keys-section,
      .context-section {
        margin-bottom: var(--space-lg);
        padding: var(--space-lg);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .section-title {
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: var(--space-md);
      }

      .keys-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-lg);
      }

      .context-section .key-display {
        margin-bottom: 0;
      }

      /* Key Material Display */
      .key-display {
        margin-bottom: var(--space-lg);
      }

      .key-display-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-xs);
      }

      .key-display-label span {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .key-display-value {
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        padding: var(--space-md);
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        color: var(--color-text-primary);
        word-break: break-all;
        line-height: var(--line-height-relaxed);
        min-height: 60px;
        max-height: calc(var(--line-height-relaxed) * 2em + var(--space-md) * 2);
        overflow: hidden;
        cursor: pointer;
        transition: all var(--transition-base);
        opacity: 0;
        animation: fadeIn var(--transition-slow) forwards;
      }

      @keyframes fadeIn {
        to { opacity: 1; }
      }

      .key-display-value.placeholder {
        color: var(--color-text-tertiary);
      }

      .copy-btn {
        padding: var(--space-xs) var(--space-sm);
        background: transparent;
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-secondary);
        font-size: var(--font-size-xs);
        font-family: var(--font-mono);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .copy-btn:hover {
        border-color: var(--color-info);
        color: var(--color-info);
      }

      .copy-btn.copied {
        border-color: var(--color-success);
        color: var(--color-success);
      }

      /* Context Options (inside context-section) */
      .context-options {
        margin-bottom: var(--space-lg);
      }

      /* Message Input Section (Full Width) */
      .message-input-section {
        margin-top: var(--space-xl);
        padding: var(--space-lg);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .message-input-row {
        display: flex;
        gap: var(--space-md);
        align-items: flex-end;
      }

      .message-input-group {
        flex: 3;
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .aad-input-group {
        flex: 1;
        min-width: 150px;
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .message-input-group label,
      .aad-input-group label {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .message-input-group input,
      .aad-input-group input {
        padding: var(--space-sm) var(--space-md);
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        transition: all var(--transition-base);
      }

      .message-input-group input:focus,
      .aad-input-group input:focus {
        outline: none;
        border-color: var(--color-info);
        box-shadow: 0 0 0 3px var(--color-info-bg);
      }

      .aad-input-group input.error {
        border-color: var(--color-error);
        background: var(--color-error-bg);
      }

      .message-actions {
        display: flex;
        gap: var(--space-sm);
        flex-shrink: 0;
      }

      /* Messages Display Section */
      .messages-display-section {
        margin-top: var(--space-xl);
        padding: var(--space-lg);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .helper-text {
        text-align: center;
        color: var(--color-text-tertiary);
        font-size: var(--font-size-sm);
        margin-top: var(--space-md);
      }

      /* Legacy Messages Section (keep for compatibility) */
      .messages-section {
        margin-top: var(--space-xl);
      }

      /* Algorithm Section (Legacy - for vector validation display) */
      .algorithm-section {
        margin-bottom: var(--space-lg);
      }

      .algorithm-section h3 {
        font-size: var(--font-size-lg);
        color: var(--color-text-primary);
        margin-bottom: var(--space-sm);
        font-weight: 600;
      }

      /* ============================================
         Vector Validation Section
         ============================================ */
      .vector-validation-content {
        transition: filter var(--transition-slow);
      }

      .vector-validation-content.blurred {
        filter: blur(1px);
        pointer-events: none;
      }

      .play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        cursor: pointer;
        transition: all var(--transition-slow);
        border-radius: var(--radius-md);
      }

      .play-overlay:hover .play-button,
      .play-overlay:focus .play-button {
        transform: scale(1.1);
      }

      .play-button {
        width: 60px;
        height: 60px;
        background: var(--color-text-secondary);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-slow);
        box-shadow: var(--shadow-md);
      }

      .play-overlay:hover .play-button,
      .play-overlay:focus .play-button {
        background: var(--color-text-tertiary);
      }

      .play-button::after {
        content: '';
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 12px 0 12px 18px;
        border-color: transparent transparent transparent #fff;
        margin-left: 4px;
      }



      .vector-validation h3 {
        font-size: var(--font-size-2xl);
        color: var(--color-text-primary);
        margin-bottom: var(--space-sm);
        font-weight: 600;
      }

      .vector-validation .subtitle-text {
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-lg);
      }

      /* Progress Bar */
      .progress-bar-container {
        background: var(--color-bg-secondary);
        height: 28px;
        margin-bottom: var(--space-sm);
        position: relative;
        display: flex;
        gap: 2px;
        padding: 3px;
        border-radius: var(--radius-sm);
        overflow: hidden;
      }

      .progress-box {
        flex: 1;
        background: var(--color-bg-tertiary);
        border-radius: 2px;
      }

      .progress-box.filled {
        background: var(--color-text-secondary);
      }

      .progress-box.filled.failed {
        background: var(--color-error);
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: var(--font-size-md);
        color: var(--color-text-secondary);
        font-family: var(--font-mono);
      }

      .progress-info .passed {
        color: var(--color-success-text);
        font-weight: 600;
      }

      .progress-info .failed {
        color: var(--color-error-text);
        font-weight: 600;
      }

      /* ============================================
         Demo Section
         ============================================ */
      .demo-section:not(.active) input,
      .demo-section:not(.active) button {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .demo-section h3 {
        font-size: var(--font-size-2xl);
        color: var(--color-text-primary);
        margin-bottom: var(--space-lg);
        font-weight: 600;
      }

      /* ============================================
         Button Components
         ============================================ */
      .demo-controls {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-xl);
        flex-wrap: wrap;
      }

      .demo-controls button,
      .ikm-input-wrapper button,
      .output-wrapper button,
      .chat-input-container button,
      .message-actions button {
        padding: var(--space-sm) var(--space-lg);
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        cursor: pointer;
        font-size: var(--font-size-md);
        font-family: var(--font-mono);
        font-weight: 500;
        transition: all var(--transition-base);
      }

      .demo-controls button:hover,
      .demo-controls button:focus,
      .ikm-input-wrapper button:hover,
      .ikm-input-wrapper button:focus,
      .output-wrapper button:hover,
      .output-wrapper button:focus,
      .chat-input-container button:hover,
      .chat-input-container button:focus,
      .message-actions button:hover,
      .message-actions button:focus {
        background: var(--color-bg-tertiary);
        border-color: var(--color-text-tertiary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
        outline: none;
      }

      .demo-controls button:disabled,
      .chat-input-container button:disabled,
      .message-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .demo-controls button:disabled:hover,
      .chat-input-container button:disabled:hover {
        transform: none;
        box-shadow: none;
      }

      /* ============================================
         Form Input Groups
         ============================================ */
      .demo-input-group {
        margin-bottom: var(--space-lg);
      }

      .demo-input-group label {
        display: block;
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        margin-bottom: var(--space-sm);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .demo-input-group input,
      .demo-input-group textarea {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        line-height: var(--line-height-base);
        transition: all var(--transition-base);
      }

      .demo-input-group input:focus,
      .demo-input-group textarea:focus {
        outline: none;
        border-color: var(--color-info);
        box-shadow: 0 0 0 3px var(--color-info-bg);
      }

      .demo-input-group input.error {
        border-color: var(--color-error);
        background: var(--color-error-bg);
      }

      .chat-input-container input.error {
        border-color: var(--color-error);
        background: var(--color-error-bg);
      }

      .demo-input-group textarea {
        resize: vertical;
        min-height: 60px;
      }

      /* Input Wrappers */
      .ikm-input-wrapper {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
      }

      .ikm-input-wrapper input {
        flex: 1;
      }

      .ikm-input-wrapper button {
        padding: var(--space-sm) var(--space-md);
        font-size: var(--font-size-base);
        white-space: nowrap;
        line-height: var(--line-height-base);
      }

      /* Advanced Options */
      .advanced-options {
        margin-bottom: var(--space-lg);
      }

      .advanced-options-toggle {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-secondary);
        cursor: pointer;
        font-size: var(--font-size-md);
        font-family: var(--font-mono);
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all var(--transition-base);
      }

      .advanced-options-toggle:hover {
        background: var(--color-bg-tertiary);
        color: var(--color-text-primary);
      }

      .advanced-options-toggle::after {
        content: '▼';
        font-size: var(--font-size-sm);
        transition: transform var(--transition-base);
      }

      .advanced-options-toggle.expanded::after {
        transform: rotate(180deg);
      }

      .advanced-options-content {
        margin-top: var(--space-md);
        padding: var(--space-md);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .mode-selector {
        display: flex;
        gap: var(--space-xl);
        margin-bottom: var(--space-lg);
      }

      .mode-selector label {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        cursor: pointer;
        color: var(--color-text-secondary);
        font-size: var(--font-size-md);
        transition: color var(--transition-base);
      }

      .mode-selector input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border: 1px solid var(--color-info);
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        transition: all var(--transition-fast);
      }

      .mode-selector input[type="radio"]:checked::before {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: var(--color-info);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .mode-selector label:hover {
        color: var(--color-text-primary);
      }

      .psk-fields {
        padding-top: var(--space-md);
        border-top: 1px solid var(--color-border-primary);
      }

      .helper-text {
        font-size: var(--font-size-sm);
        color: var(--color-text-tertiary);
        margin-top: var(--space-xs);
      }

      .output-wrapper {
        display: flex;
        gap: var(--space-sm);
        align-items: flex-start;
      }

      .output-wrapper .demo-output {
        flex: 1;
        min-width: 0;
        margin-bottom: 0;
      }

      .output-wrapper button {
        padding: var(--space-sm) var(--space-md);
        font-size: var(--font-size-base);
        white-space: nowrap;
        flex-shrink: 0;
        line-height: var(--line-height-base);
      }

      .demo-output {
        background: var(--color-bg-secondary);
        padding: var(--space-sm);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        margin-bottom: var(--space-lg);
        transition: all var(--transition-base);
      }

      .demo-output:hover,
      .demo-output:focus {
        border-color: var(--color-info);
        background: var(--color-info-bg);
        outline: none;
      }

      /* ============================================
         Chat Components
         ============================================ */
      .chat-container {
        margin-top: var(--space-xl);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        background: var(--color-bg-secondary);
        padding: var(--space-lg);
        max-height: 400px;
        overflow-y: auto;
        scroll-behavior: smooth;
      }

      .chat-container::-webkit-scrollbar {
        width: 8px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: var(--color-bg-primary);
        border-radius: var(--radius-sm);
      }

      .chat-container::-webkit-scrollbar-thumb {
        background: var(--color-border-primary);
        border-radius: var(--radius-sm);
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-tertiary);
      }

      .chat-message {
        margin-bottom: var(--space-lg);
        padding: var(--space-sm);
        background: var(--color-bg-primary);
        border-left: 3px solid var(--color-success);
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .chat-message.ciphertext {
        border-left-color: var(--color-info) !important;
        cursor: pointer;
        transition: background var(--transition-base);
      }

      .chat-message.ciphertext:hover,
      .chat-message.ciphertext:focus {
        background: var(--color-info-bg);
        outline: none;
      }

      .chat-message.ciphertext[style*="cursor: not-allowed"] {
        cursor: not-allowed;
      }

      .chat-message.ciphertext[style*="cursor: not-allowed"]:hover {
        background: var(--color-bg-primary);
      }

      .chat-message-label {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .chat-message.ciphertext.clickable .chat-message-label:first-of-type::after {
        content: " (click to decrypt)";
        color: var(--color-info);
        font-weight: 600;
      }

      .chat-message.ciphertext[style*="cursor: not-allowed"] .chat-message-label:first-of-type::after {
        content: "";
        color: var(--color-text-tertiary);
        font-weight: normal;
      }

      .chat-message-content {
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        word-break: break-all;
        line-height: var(--line-height-relaxed);
      }

      .chat-message-content::selection,
      .chat-message-label::selection {
        background: transparent;
        color: inherit;
      }

      .chat-input-container {
        display: flex;
        gap: var(--space-sm);
        margin-top: var(--space-lg);
      }

      .chat-input-container input {
        flex: 1;
        padding: var(--space-sm) var(--space-sm);
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        font-family: var(--font-mono);
        font-size: var(--font-size-md);
        line-height: var(--line-height-base);
        transition: all var(--transition-base);
      }

      .chat-input-container input:focus {
        outline: none;
        border-color: var(--color-info);
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
      }

      .chat-input-container button {
        padding: var(--space-sm) var(--space-xl);
        font-size: var(--font-size-md);
        line-height: var(--line-height-base);
      }

      /* Auto-populate Button */
      #autoPopulateButton {
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border-primary);
      }

      #autoPopulateButton:hover,
      #autoPopulateButton:focus {
        background: var(--color-bg-tertiary);
        border-color: var(--color-text-tertiary);
      }

      /* ============================================
         Utility Classes
         ============================================ */
      .hidden {
        display: none !important;
      }

      .clickable {
        cursor: pointer;
        opacity: 1;
      }

      .not-clickable {
        cursor: not-allowed;
        opacity: 0.5;
      }

      .decrypted {
        cursor: default;
        opacity: 1;
      }

      .mt-lg {
        margin-top: var(--space-xl);
      }

      .suite-display {
        margin-bottom: var(--space-md);
        padding: var(--space-sm);
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border-primary);
        border-radius: var(--radius-sm);
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        text-align: center;
      }

      .aad-input-short {
        flex: 0.5;
      }

      .copy-flash {
        background: var(--color-info);
      }

      /* ============================================
         Responsive Styles (Tablet/Mobile)
         ============================================ */
      @media (max-width: 1024px) {
        .keys-grid {
          grid-template-columns: 1fr;
        }

        .algorithm-selector {
          flex-direction: column;
        }

        .algo-select-group {
          min-width: 100%;
        }

        .message-input-row {
          flex-direction: column;
          align-items: stretch;
        }

        .message-input-group,
        .aad-input-group {
          flex: none;
          width: 100%;
        }

        .message-actions {
          justify-content: flex-end;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 0;
        }

        /* Hide advanced options and AAD input on mobile */
        .context-options,
        .aad-input-group,
        .download-vector-btn {
          display: none;
        }

        .container {
          padding: var(--space-md);
          display: flex;
          flex-direction: column;
          border-radius: 0;
        }

        /* Header Mobile */
        .header {
          flex-wrap: wrap;
          order: 1;
          gap: var(--space-md);
        }

        h1 {
          font-size: var(--font-size-3xl);
          flex: 1;
        }

        .header > div:first-child {
          flex-direction: row;
          align-items: center;
          gap: var(--space-sm);
        }

        .social-links {
          gap: var(--space-sm);
        }

        .social-links a svg {
          width: 20px;
          height: 20px;
        }

        .burger-menu {
          display: flex;
        }

        /* Filter Links Mobile */
        .filter-links {
          display: none;
          flex-direction: column;
          width: 100%;
          order: 3;
          gap: var(--space-sm);
        }

        .filter-links.open {
          display: flex;
        }

        .filter-links a {
          text-align: center;
          padding: var(--space-md);
        }

        .subtitle {
          order: 2;
          font-size: var(--font-size-md);
          margin-bottom: var(--space-xl);
        }

        /* Sections Mobile Ordering */
        .demo-section {
          order: 3;
          margin-top: var(--space-xl);
          margin-bottom: var(--space-xl);
          padding: var(--space-md);
        }

        .components-section {
          order: 4;
          margin-top: var(--space-xl);
          margin-bottom: var(--space-xl);
          padding: var(--space-md);
        }

        .vector-validation {
          order: 5;
          margin-top: var(--space-xl);
          padding: var(--space-md);
        }

        .vector-validation .progress-bar-container {
          order: -1;
          margin-bottom: var(--space-lg);
        }

        /* Typography Mobile */
        .demo-section h3,
        .vector-validation h3 {
          font-size: var(--font-size-xl);
          margin-bottom: var(--space-md);
        }

        .algorithm-section h3 {
          font-size: var(--font-size-md);
        }

        /* Controls Mobile */
        .demo-controls {
          gap: var(--space-sm);
          margin-bottom: var(--space-md);
        }

        .demo-controls button {
          font-size: var(--font-size-base);
          padding: var(--space-sm) var(--space-md);
        }

        /* Input Groups Mobile */
        .demo-input-group {
          margin-bottom: var(--space-md);
        }

        .demo-input-group label,
        .demo-output-group label {
          font-size: var(--font-size-sm);
          margin-bottom: var(--space-xs);
        }

        /* Input Wrappers Mobile */
        .ikm-input-wrapper {
          display: flex;
          flex-wrap: wrap;
          flex-direction: row;
          justify-content: flex-end;
          gap: var(--space-sm);
        }

        .ikm-input-wrapper input {
          flex: 1 1 100%;
          font-size: var(--font-size-sm);
          padding: var(--space-sm);
        }

        .ikm-input-wrapper button {
          padding: var(--space-sm) var(--space-md);
          font-size: var(--font-size-sm);
        }

        .output-wrapper {
          flex-direction: column;
          gap: var(--space-sm);
        }

        .output-wrapper .demo-output {
          min-width: 0;
          width: 100%;
          margin-bottom: 0;
          font-size: var(--font-size-sm);
        }

        .output-wrapper button {
          width: auto;
          align-self: flex-end;
          padding: var(--space-sm) var(--space-md);
          font-size: var(--font-size-sm);
        }

        /* Form Inputs Mobile */
        .demo-input-group input,
        .demo-input-group textarea {
          font-size: var(--font-size-lg);
          padding: var(--space-md) var(--space-sm);
        }

        .demo-input-group .ikm-input-wrapper input {
          font-size: var(--font-size-sm);
          padding: var(--space-sm);
        }

        .demo-output {
          font-size: var(--font-size-sm);
          padding: var(--space-sm);
          margin-bottom: var(--space-md);
        }

        /* Chat Mobile */
        .chat-container {
          padding: var(--space-sm);
          max-height: 300px;
          margin-top: var(--space-md);
        }

        .chat-message {
          padding: var(--space-sm);
          margin-bottom: var(--space-sm);
        }

        .chat-message-label {
          font-size: var(--font-size-xs);
        }

        .chat-message-content {
          font-size: var(--font-size-sm);
          word-break: break-word;
        }

        .chat-input-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: flex-end;
          gap: var(--space-sm);
          margin-top: var(--space-sm);
        }

        .chat-input-container input {
          flex: 1 1 100%;
          font-size: var(--font-size-lg);
          padding: var(--space-md) var(--space-sm);
          margin-right: 0;
        }

        .chat-input-container button {
          padding: var(--space-sm) var(--space-md);
          font-size: var(--font-size-sm);
        }

        #autoPopulateButton {
          margin-left: 0;
        }

        /* Play Button Mobile */
        .play-button {
          width: 50px;
          height: 50px;
        }

        .play-button::after {
          border-width: 10px 0 10px 15px;
        }

        /* Legend Mobile */
        .legend {
          gap: var(--space-md);
          padding: var(--space-sm);
        }

        .legend-item {
          font-size: var(--font-size-base);
        }

        /* Progress Bar Mobile */
        .progress-bar-container {
          height: 24px;
        }

        .progress-info {
          font-size: var(--font-size-base);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <h1>@panva/hpke</h1>
          <div class="social-links">
            <a href="https://github.com/panva/hpke" target="_blank">
              <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                <path
                  d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
                ></path>
              </svg>
            </a>
            <a href="https://www.npmjs.com/package/@panva/hpke" target="_blank">
              <svg viewBox="0 0 780 250" fill="currentColor" aria-hidden="true">
                <path
                  d="M240,250h100v-50h100V0H240V250z M340,50h50v100h-50V50z M480,0v200h100V50h50v150h50V50h50v150h50V0H480z M0,200h100V50h50v150h50V0H0V200z"
                ></path>
              </svg>
            </a>
            <a href="https://x.com/_panva" target="_blank">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path
                  d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                ></path>
              </svg>
            </a>
            <a href="https://www.linkedin.com/in/filipskokan/" target="_blank">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path
                  d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                ></path>
              </svg>
            </a>
          </div>
        </div>
        <button class="burger-menu" id="burgerMenu" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="filter-links" id="filterLinks">
          <a href="?native" id="filterNative">Web Cryptography</a>
          <a href="?noble" id="filterNoble">Noble Cryptography</a>
          <a href="./" id="filterBoth">both</a>
        </div>
      </div>
      <p class="subtitle">HPKE demo and vector validation test suite for all KEM, KDF, and AEAD implementations in your browser.</p>

      <div class="demo-section" id="demoSection">
        <div class="section-label">Demo</div>
        <button class="download-vector-btn" id="downloadVectorBtn" title="Download test vector" disabled>Download Vector</button>

        <!-- Algorithm Selector -->
        <div class="algorithm-selector" id="algorithmSelector">
          <div class="algo-select-group">
            <label for="kemSelect" id="kemLabel">KEM</label>
            <div class="algo-select-wrapper">
              <select id="kemSelect" class="algo-select">
                <option value="" disabled selected>Select KEM...</option>
              </select>
            </div>
          </div>
          <div class="algo-select-group">
            <label for="kdfSelect" id="kdfLabel">KDF</label>
            <div class="algo-select-wrapper">
              <select id="kdfSelect" class="algo-select">
                <option value="" disabled selected>Select KDF...</option>
              </select>
            </div>
          </div>
          <div class="algo-select-group">
            <label for="aeadSelect" id="aeadLabel">AEAD</label>
            <div class="algo-select-wrapper">
              <select id="aeadSelect" class="algo-select">
                <option value="" disabled selected>Select AEAD...</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Key Derivation from IKM -->
        <div class="ikm-section">
          <div class="demo-input-group">
            <label>Input Keying Material (IKM, hex):</label>
            <div class="ikm-input-wrapper">
              <input type="text" id="ikmInput" value="…">
              <button id="zeroIkmButton" title="Set to zero">0x00…</button>
              <button id="randomIkmButton" title="Randomize">rand()</button>
            </div>
          </div>
        </div>

        <!-- Keys Section -->
        <div class="keys-section">
          <div class="section-title">Keys</div>
          <div class="keys-grid">
            <div class="key-display">
              <div class="key-display-label">
                <span>Public Key</span>
                <button class="copy-btn" data-copy="publicKeyOutput">Copy</button>
              </div>
              <div class="key-display-value placeholder" id="publicKeyOutput">…</div>
            </div>
            <div class="key-display" id="privateKeyOutputGroup">
              <div class="key-display-label">
                <span>Private Key</span>
                <button class="copy-btn" data-copy="privateKeyOutput">Copy</button>
              </div>
              <div class="key-display-value placeholder" id="privateKeyOutput">…</div>
            </div>
          </div>
        </div>

        <!-- Context Section -->
        <div class="context-section">
          <div class="section-title">Context</div>

          <!-- Context Options -->
          <div class="context-options">
            <!-- Info -->
            <div class="demo-input-group">
              <label>Info (hex, optional):</label>
              <div class="ikm-input-wrapper">
                <input type="text" id="infoInput">
                <button id="zeroInfoButton" title="Set to 32 zero bytes">0x00…</button>
                <button id="randomInfoButton" title="Generate random 32 bytes">rand()</button>
              </div>
            </div>

            <!-- Mode Selector -->
            <div class="mode-selector">
              <label>
                <input type="radio" name="mode" value="base" id="modeBase" checked>
                <span>Base Mode</span>
              </label>
              <label>
                <input type="radio" name="mode" value="psk" id="modePsk">
                <span>PSK Mode</span>
              </label>
            </div>

            <!-- PSK Fields -->
            <div class="psk-fields hidden" id="pskFields">
              <div class="demo-input-group">
                <label>Pre-Shared Key (PSK, hex, ≥32 bytes):</label>
                <div class="ikm-input-wrapper">
                  <input type="text" id="pskInput">
                  <button id="randomPskButton" title="Generate random 32 bytes">rand()</button>
                </div>
              </div>
              <div class="demo-input-group">
                <label>PSK ID (hex, >0 bytes):</label>
                <div class="ikm-input-wrapper">
                  <input type="text" id="pskIdInput">
                  <button id="randomPskIdButton" title="Generate random 8 bytes">rand()</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Encapsulated Key -->
          <div class="key-display">
            <div class="key-display-label">
              <span>Encapsulated Key</span>
              <button class="copy-btn" data-copy="encapsulatedKeyOutput">Copy</button>
            </div>
            <div class="key-display-value placeholder" id="encapsulatedKeyOutput">…</div>
          </div>
        </div>

        <!-- Message Input (Full Width) -->
        <div class="message-input-section">
          <div class="message-input-row">
            <div class="message-input-group">
              <label for="messageInput">Plaintext</label>
              <input type="text" id="messageInput" placeholder="Type a message to encrypt..." aria-label="Message to encrypt">
            </div>
            <div class="aad-input-group">
              <label for="aadInput">AAD (hex, optional)</label>
              <input type="text" id="aadInput" aria-label="Additional authenticated data">
            </div>
            <div class="message-actions">
              <button id="sendButton" aria-label="Encrypt message">encrypt()</button>
              <button id="autoPopulateButton" title="Auto-populate with random text" aria-label="Auto-populate with sample text">rand()</button>
            </div>
          </div>
        </div>

        <!-- Messages Display -->
        <div class="messages-display-section hidden" id="messagesDisplaySection">
          <div class="section-title">Messages</div>
          <div class="chat-container" id="chatContainer" role="log" aria-live="polite" aria-label="Encrypted messages"></div>
          <div class="helper-text" id="decryptHint">Click ciphertext messages to decrypt them in sequence</div>
        </div>
      </div>

      <div class="vector-validation" id="vectorValidation">
        <div class="section-label">RFC Test Vectors</div>
        <div class="play-overlay hidden" id="playOverlay">
          <div class="play-button" id="playButton"></div>
        </div>
        <div class="vector-validation-content blurred" id="vectorValidationContent">
          <p class="subtitle-text">
            Testing all encryptions and exports from RFC test vectors with functional implementations
          </p>
        <div class="progress-bar-container" id="vectorProgressContainer">
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
          <div class="progress-box"></div>
        </div>
        <div class="progress-info" id="vectorProgressInfo">
          <span>Pending…</span>
        </div>
        </div>
      </div>
    </div>

    <script type="module">
      // ============================================================================
      // CONFIGURATION & INITIALIZATION
      // ============================================================================

      const params = new URLSearchParams(window.location.search)
      const onlyNative = params.has('native')
      const onlyNoble = params.has('noble')
      const ci = params.has('ci')
      const both = (onlyNative && onlyNoble) || (!onlyNative && !onlyNoble)

      // Highlight active filter in header
      const activeFilter = onlyNative ? 'native' : onlyNoble ? 'noble' : 'both'
      document.getElementById('filter' + activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1)).classList.add('active')

      import * as HPKE from '@panva/hpke'
      import * as Noble from '@panva/hpke-noble'
      import Bowser from 'bowser'

      import vectors from './test/vectors.json' with { type: 'json' }
      import vectorsPq from './test/vectors-pq.json' with { type: 'json' }
      const allVectors = [...vectors, ...vectorsPq].filter((v) => {
        if (v.mode !== 0x00 && v.mode !== 0x01) return false
        return true
      })

      // ============================================================================
      // ALGORITHM DISCOVERY
      // ============================================================================
      // Dynamically extract all algorithms from HPKE and Noble libraries based on
      // name prefixes (KEM_, KDF_, AEAD_)

      /** Extracts algorithms from a library object by prefix */
      const extractAlgorithms = (library, prefix, label, isNoble = false) =>
        Object.keys(library)
          .filter(key => key.startsWith(prefix))
          .map(name => ({ name, displayName: `[${label}] ${name}`, factory: library[name], isNoble }))
          .sort((a, b) => a.name.localeCompare(b.name))

      // Extract native HPKE algorithms
      const KEMS = extractAlgorithms(HPKE, 'KEM_', 'native')
      const KDFS = extractAlgorithms(HPKE, 'KDF_', 'native')
      const AEADS = extractAlgorithms(HPKE, 'AEAD_', 'native').filter((x) => x.name !== 'AEAD_EXPORT_ONLY')

      // Extract Noble (extensibility) algorithms
      const NOBLE_KEMS = extractAlgorithms(Noble, 'KEM_', 'extensibility', true)
      const NOBLE_KDFS = extractAlgorithms(Noble, 'KDF_', 'extensibility', true)
      const NOBLE_AEADS = extractAlgorithms(Noble, 'AEAD_', 'extensibility', true)

      // UI Event Handlers
      document.getElementById('burgerMenu').addEventListener('click', () =>
        document.getElementById('filterLinks').classList.toggle('open')
      )

      // Combine native and Noble implementations based on query params
      const ALL_KEMS = both ? KEMS.concat(NOBLE_KEMS) : onlyNative ? KEMS : NOBLE_KEMS
      const ALL_KDFS = both ? KDFS.concat(NOBLE_KDFS) : onlyNative ? KDFS : NOBLE_KDFS
      const ALL_AEADS = both ? AEADS.concat(NOBLE_AEADS) : onlyNative ? AEADS : NOBLE_AEADS

      // ============================================================================
      // ALGORITHM ID MAPPINGS
      // ============================================================================
      // Static mapping of algorithm names to their IDs from the HPKE specification

      const ALGORITHM_IDS = {
        // KEMs
        KEM_DHKEM_P256_HKDF_SHA256: 0x0010,
        KEM_DHKEM_P384_HKDF_SHA384: 0x0011,
        KEM_DHKEM_P521_HKDF_SHA512: 0x0012,
        KEM_DHKEM_X25519_HKDF_SHA256: 0x0020,
        KEM_DHKEM_X448_HKDF_SHA512: 0x0021,
        KEM_ML_KEM_512: 0x0040,
        KEM_ML_KEM_768: 0x0041,
        KEM_ML_KEM_1024: 0x0042,
        KEM_MLKEM768_P256: 0x0050,
        KEM_MLKEM1024_P384: 0x0051,
        KEM_MLKEM768_X25519: 0x647a,

        // KDFs
        KDF_HKDF_SHA256: 0x0001,
        KDF_HKDF_SHA384: 0x0002,
        KDF_HKDF_SHA512: 0x0003,
        KDF_SHAKE128: 0x0010,
        KDF_SHAKE256: 0x0011,
        KDF_TurboSHAKE128: 0x0012,
        KDF_TurboSHAKE256: 0x0013,

        // AEADs
        AEAD_AES_128_GCM: 0x0001,
        AEAD_AES_256_GCM: 0x0002,
        AEAD_ChaCha20Poly1305: 0x0003,
        AEAD_EXPORT_ONLY: 0xffff,
      }

      // Mapping of algorithm names to their display names
      const ALGORITHM_NAMES = {
        // KEMs
        KEM_DHKEM_P256_HKDF_SHA256: 'DHKEM(P-256, HKDF-SHA256)',
        KEM_DHKEM_P384_HKDF_SHA384: 'DHKEM(P-384, HKDF-SHA384)',
        KEM_DHKEM_P521_HKDF_SHA512: 'DHKEM(P-521, HKDF-SHA512)',
        KEM_DHKEM_X25519_HKDF_SHA256: 'DHKEM(X25519, HKDF-SHA256)',
        KEM_DHKEM_X448_HKDF_SHA512: 'DHKEM(X448, HKDF-SHA512)',
        KEM_ML_KEM_512: 'ML-KEM-512',
        KEM_ML_KEM_768: 'ML-KEM-768',
        KEM_ML_KEM_1024: 'ML-KEM-1024',
        KEM_MLKEM768_P256: 'MLKEM768-P256',
        KEM_MLKEM1024_P384: 'MLKEM1024-P384',
        KEM_MLKEM768_X25519: 'MLKEM768-X25519',

        // KDFs
        KDF_HKDF_SHA256: 'HKDF-SHA256',
        KDF_HKDF_SHA384: 'HKDF-SHA384',
        KDF_HKDF_SHA512: 'HKDF-SHA512',
        KDF_SHAKE128: 'SHAKE128',
        KDF_SHAKE256: 'SHAKE256',
        KDF_TurboSHAKE128: 'TurboSHAKE128',
        KDF_TurboSHAKE256: 'TurboSHAKE256',

        // AEADs
        AEAD_AES_128_GCM: 'AES-128-GCM',
        AEAD_AES_256_GCM: 'AES-256-GCM',
        AEAD_ChaCha20Poly1305: 'ChaCha20Poly1305',
        AEAD_EXPORT_ONLY: 'Export-only',
      }

      // Validate that all algorithms have IDs and names in the maps
      const allAlgorithms = [
        ...KEMS,
        ...KDFS,
        ...AEADS,
        ...NOBLE_KEMS,
        ...NOBLE_KDFS,
        ...NOBLE_AEADS,
      ]
      const missingIds = []
      const missingNames = []

      for (const algo of allAlgorithms) {
        if (!(algo.name in ALGORITHM_IDS)) {
          missingIds.push(algo.name)
        }
        if (!(algo.name in ALGORITHM_NAMES)) {
          missingNames.push(algo.name)
        }
      }

      if (missingIds.length > 0 || missingNames.length > 0) {
        const errors = []
        if (missingIds.length > 0) {
          errors.push(`Missing ALGORITHM_IDS entries: ${missingIds.join(', ')}`)
        }
        if (missingNames.length > 0) {
          errors.push(`Missing ALGORITHM_NAMES entries: ${missingNames.join(', ')}`)
        }
        throw new Error(`Configuration Error:\n${errors.join('\n')}`)
      }

      // ============================================================================
      // BASELINE CONFIGURATION
      // ============================================================================
      // When testing a specific component (e.g., a KEM), we pair it with baseline
      // KDF and AEAD to isolate the test. These are the baseline algorithms.

      const baselineKEM = KEMS.find((k) => k.name === 'KEM_DHKEM_P256_HKDF_SHA256')
      const baselineKDF = KDFS.find((k) => k.name === 'KDF_HKDF_SHA256')
      const baselineAEAD = AEADS.find((a) => a.name === 'AEAD_AES_128_GCM')

      // ============================================================================
      // BROWSER COMPATIBILITY
      // ============================================================================
      // Some algorithms are not supported in browsers due to missing Web Crypto APIs
      // Noble implementations provide fallbacks for these
      // Browser-specific unsupported algorithms based on Web Crypto API availability

      /** Detects the current browser engine and version */
      const detectBrowser = () => {
        const browser = Bowser.getParser(navigator.userAgent)
        return { engine: browser.getEngineName(), version: parseInt(browser.getBrowserVersion()) }
      }

      const unsupported = {
        kem: [
          'KEM_DHKEM_X448_HKDF_SHA512',
          'KEM_ML_KEM_512',
          'KEM_ML_KEM_768',
          'KEM_ML_KEM_1024',
          'KEM_MLKEM768_X25519',
          'KEM_MLKEM768_P256',
          'KEM_MLKEM1024_P384',
        ],
        kdf: ['KDF_SHAKE128', 'KDF_SHAKE256'],
        aead: ['AEAD_ChaCha20Poly1305'],
      }

      const browser = detectBrowser()

      switch (true) {
        case browser.engine === 'Gecko' && browser.version < 143:
          // https://bugzilla.mozilla.org/show_bug.cgi?id=1932396
          unsupported.kem.push('KEM_DHKEM_X25519_HKDF_SHA256')
          break
      }

      /** Determines if a test is expected to fail based on browser support */
      const isExpectedToFail = (test) => {
        const component = test[test.testingComponent]
        // Noble implementations provide fallbacks and always pass
        if (component.isNoble) return false
        return unsupported[test.testingComponent].includes(component.name)
      }

      // ============================================================================
      // HELPER FUNCTIONS
      // ============================================================================

      // Cache commonly used DOM elements
      const elements = {
        ikmInput: document.getElementById('ikmInput'),
        infoInput: document.getElementById('infoInput'),
        pskInput: document.getElementById('pskInput'),
        pskIdInput: document.getElementById('pskIdInput'),
        aadInput: document.getElementById('aadInput'),
        messageInput: document.getElementById('messageInput'),
        pskFields: document.getElementById('pskFields'),
        chatContainer: document.getElementById('chatContainer'),
        messagesDisplaySection: document.getElementById('messagesDisplaySection'),
        publicKeyOutput: document.getElementById('publicKeyOutput'),
        privateKeyOutput: document.getElementById('privateKeyOutput'),
        privateKeyOutputGroup: document.getElementById('privateKeyOutputGroup'),
        encapsulatedKeyOutput: document.getElementById('encapsulatedKeyOutput'),
        sendButton: document.getElementById('sendButton'),
        autoPopulateButton: document.getElementById('autoPopulateButton'),
        downloadVectorBtn: document.getElementById('downloadVectorBtn'),
        demoSection: document.getElementById('demoSection'),
      }

      /** Sets an element to placeholder state */
      const setPlaceholder = (element) => {
        element.textContent = ''
        element.classList.add('placeholder')
      }

      /** Clears messages display */
      const clearMessages = () => {
        elements.chatContainer.innerHTML = ''
        elements.messagesDisplaySection.classList.add('hidden')
      }

      /** Checks if any input field has validation errors */
      const hasValidationErrors = () => [
        elements.aadInput, elements.ikmInput, elements.infoInput,
        elements.pskInput, elements.pskIdInput
      ].some(el => el.classList.contains('error'))

      /** Selects the preferred algorithm implementation (native over noble if both pass) */
      const selectPreferredAlgorithm = (algorithms, algoName, algoType) => {
        const nativeAlgo = algorithms.find(a => a.name === algoName && !a.isNoble)
        const nobleAlgo = algorithms.find(a => a.name === algoName && a.isNoble)

        const nativeTest = tests.find(t => {
          const component = getTestComponent(t)
          return component.name === algoName && t.testingComponent === algoType && !component.isNoble
        })
        const nativePassed = nativeTest?.status === 'passed'

        return (nativePassed && nativeAlgo) || nobleAlgo || nativeAlgo
      }

      /** Validates hex input and updates element error state */
      const validateHexInput = (element, minBytes = 0) => {
        const value = element.value.trim()
        if (!value) {
          element.classList.remove('error')
          return null
        }

        try {
          const data = Uint8Array.fromHex(value)
          if (minBytes > 0 && data.length < minBytes) {
            element.classList.add('error')
            return null
          }
          element.classList.remove('error')
          return data
        } catch {
          element.classList.add('error')
          return null
        }
      }

      /** Generates random bytes and updates input field */
      const setRandomHex = (element, byteCount) => {
        const random = crypto.getRandomValues(new Uint8Array(byteCount))
        element.value = random.toHex()
        element.classList.remove('error')
        return random
      }

      /** Sets input to all zeros */
      const setZeroHex = (element, byteCount) => {
        const zero = '00'.repeat(byteCount)
        element.value = zero
        element.classList.remove('error')
        return Uint8Array.fromHex(zero)
      }

      /** Resets chat and sets up fresh context */
      const resetAndSetupContext = async () => {
        clearMessages()
        await setupSenderContext()
      }

      // ============================================================================
      // STATE MANAGEMENT
      // ============================================================================

      let tests = []

      // Track passing implementations by algorithm ID
      const passingImplementations = {
        kem: new Map(), // id -> [factories]
        kdf: new Map(), // id -> [factories]
        aead: new Map(), // id -> [factories]
      }

      // ============================================================================
      // TEST GENERATION
      // ============================================================================

      /** Generates the full test suite - tests each component with baseline values for others */
      const generateTests = () => {
        const testList = []
        const testConfigs = [
          { algorithms: ALL_KEMS, component: 'kem', baselines: { kdf: baselineKDF, aead: baselineAEAD } },
          { algorithms: ALL_KDFS, component: 'kdf', baselines: { kem: baselineKEM, aead: baselineAEAD } },
          { algorithms: ALL_AEADS, component: 'aead', baselines: { kem: baselineKEM, kdf: baselineKDF } }
        ]

        testConfigs.forEach(({ algorithms, component, baselines }) => {
          algorithms.forEach(algorithm => {
            const test = {
              id: testList.length,
              ...baselines,
              [component]: algorithm,
              testingComponent: component,
              status: 'pending',
              error: null,
              expectedToFail: false
            }
            test.expectedToFail = isExpectedToFail(test)
            testList.push(test)
          })
        })
        return testList
      }

      // ============================================================================
      // UI RENDERING FUNCTIONS
      // ============================================================================

      /** Gets the component object from a test based on the test's component type */
      const getTestComponent = (test) => test[test.testingComponent]

      /** Determines the display status for an algorithm card */
      function getAlgorithmStatus(algoName, algoType) {
        // Find ALL tests for this algorithm (native and extensibility)
        const relatedTests = tests.filter((t) => {
          const component = getTestComponent(t)
          return component.name === algoName && t.testingComponent === algoType
        })

        if (relatedTests.length === 0) {
          return 'pending'
        }

        // Check if any test is running
        if (relatedTests.some((t) => t.status === 'running')) {
          return 'testing'
        }

        // Check if any test is still pending
        if (relatedTests.some((t) => t.status === 'pending')) {
          return 'pending'
        }

        // Check if any test passed
        const anyPassed = relatedTests.some((t) => t.status === 'passed')

        if (anyPassed) {
          return 'supported'
        }

        // All failed or no passing tests
        return 'unsupported'
      }

      // ============================================================================
      // DEMO SECTION STATE
      // ============================================================================
      const demoState = {
        selectedKEM: null,
        selectedKDF: null,
        selectedAEAD: null,
        suite: null,
        recipientKeyPair: null,
        senderContext: null,
        recipientContext: null,
        encapsulatedKey: null,
        mode: 'base',
        info: null,
        psk: null,
        pskId: null,
      }

      /**
       * Renders the algorithm dropdowns and algorithm cards for vector validation
       */
      function renderAlgorithmSummary() {
        // Get unique algorithm names
        const kemNames = [...new Set(ALL_KEMS.map((k) => k.name))].sort()
        const kdfNames = [...new Set(ALL_KDFS.map((k) => k.name))].sort()
        const aeadNames = [...new Set(ALL_AEADS.map((a) => a.name))].sort()

        // Categorize KEMs
        const traditionalKEMs = kemNames
          .filter((name) => name.startsWith('KEM_DHKEM_'))
          .sort((a, b) => {
            // Custom sort: P-256, X25519, P-384, P-521, X448
            const order = [
              'KEM_DHKEM_P256_HKDF_SHA256',
              'KEM_DHKEM_X25519_HKDF_SHA256',
              'KEM_DHKEM_P384_HKDF_SHA384',
              'KEM_DHKEM_P521_HKDF_SHA512',
              'KEM_DHKEM_X448_HKDF_SHA512',
            ]
            return order.indexOf(a) - order.indexOf(b)
          })
        const postQuantumKEMs = kemNames
          .filter((name) => name.startsWith('KEM_ML_KEM_'))
          .sort((a, b) => {
            // Sort ML-KEM by security level: 512, 768, 1024
            const getLevel = (name) => parseInt(name.match(/\d+$/)?.[0] || '0')
            return getLevel(a) - getLevel(b)
          })
        const hybridKEMs = kemNames
          .filter((name) => name.startsWith('KEM_MLKEM'))
          .sort((a, b) => {
            // Custom sort: MLKEM768-P256, MLKEM768-X25519, MLKEM1024-P384
            const order = ['KEM_MLKEM768_P256', 'KEM_MLKEM768_X25519', 'KEM_MLKEM1024_P384']
            return order.indexOf(a) - order.indexOf(b)
          })

        // Populate KEM dropdown
        const kemSelect = document.getElementById('kemSelect')
        kemSelect.innerHTML = '<option value="" disabled>Select KEM...</option>'

        const addKemGroup = (label, kems) => {
          if (kems.length === 0) return
          const optgroup = document.createElement('optgroup')
          optgroup.label = label
          kems.forEach(name => {
            const status = getAlgorithmStatus(name, 'kem')
            const opt = document.createElement('option')
            opt.value = name
            opt.textContent = ALGORITHM_NAMES[name]
            opt.dataset.status = status
            if (status === 'unsupported') opt.disabled = true
            optgroup.appendChild(opt)
          })
          kemSelect.appendChild(optgroup)
        }

        addKemGroup('Traditional', traditionalKEMs)
        addKemGroup('Hybrid (PQ/T)', hybridKEMs)
        addKemGroup('Post-Quantum', postQuantumKEMs)

        // Populate KDF dropdown
        const kdfSelect = document.getElementById('kdfSelect')
        kdfSelect.innerHTML = '<option value="" disabled>Select KDF...</option>'
        kdfNames.forEach(name => {
          const status = getAlgorithmStatus(name, 'kdf')
          const opt = document.createElement('option')
          opt.value = name
          opt.textContent = ALGORITHM_NAMES[name]
          opt.dataset.status = status
          if (status === 'unsupported') opt.disabled = true
          kdfSelect.appendChild(opt)
        })

        // Populate AEAD dropdown
        const aeadSelect = document.getElementById('aeadSelect')
        aeadSelect.innerHTML = '<option value="" disabled>Select AEAD...</option>'
        aeadNames.forEach(name => {
          const status = getAlgorithmStatus(name, 'aead')
          const opt = document.createElement('option')
          opt.value = name
          opt.textContent = ALGORITHM_NAMES[name]
          opt.dataset.status = status
          if (status === 'unsupported' || name === 'AEAD_EXPORT_ONLY') opt.disabled = true
          aeadSelect.appendChild(opt)
        })

        // Update label to show package name based on selected algorithm
        const updateLabel = (labelId, selectedAlgo, defaultText) => {
          const label = document.getElementById(labelId)
          if (selectedAlgo) {
            const pkg = selectedAlgo.isNoble ? 'Noble Cryptography' : 'Web Cryptography'
            label.innerHTML = `${defaultText} <span class="pkg-name">(${pkg})</span>`
          } else {
            label.textContent = defaultText
          }
        }

        // Add change handlers for dropdowns
        kemSelect.addEventListener('change', () => {
          const algoName = kemSelect.value
          demoState.selectedKEM = selectPreferredAlgorithm(ALL_KEMS, algoName, 'kem')
          updateLabel('kemLabel', demoState.selectedKEM, 'KEM')
          updateDemoSection()
        })

        kdfSelect.addEventListener('change', () => {
          const algoName = kdfSelect.value
          demoState.selectedKDF = selectPreferredAlgorithm(ALL_KDFS, algoName, 'kdf')
          updateLabel('kdfLabel', demoState.selectedKDF, 'KDF')
          updateDemoSection()
        })

        aeadSelect.addEventListener('change', () => {
          const algoName = aeadSelect.value
          demoState.selectedAEAD = selectPreferredAlgorithm(ALL_AEADS, algoName, 'aead')
          updateLabel('aeadLabel', demoState.selectedAEAD, 'AEAD')
          updateDemoSection()
        })

        // Auto-select first available algorithm
        const autoSelectFirst = (select, algorithms, type) => {
          for (const opt of select.options) {
            if (opt.disabled) continue
            select.value = opt.value
            const stateKey = `selected${type.toUpperCase()}`
            demoState[stateKey] = selectPreferredAlgorithm(algorithms, opt.value, type)
            break
          }
        }

        autoSelectFirst(kemSelect, ALL_KEMS, 'kem')
        autoSelectFirst(kdfSelect, ALL_KDFS, 'kdf')
        autoSelectFirst(aeadSelect, ALL_AEADS, 'aead')

        // Update labels after auto-selection
        updateLabel('kemLabel', demoState.selectedKEM, 'KEM')
        updateLabel('kdfLabel', demoState.selectedKDF, 'KDF')
        updateLabel('aeadLabel', demoState.selectedAEAD, 'AEAD')

        // Update demo section once after all three are selected
        updateDemoSection()
      }

      // ============================================================================
      // DEMO SECTION FUNCTIONALITY
      // ============================================================================

      function resetDemoState() {
        // Reset all demo state
        demoState.recipientKeyPair = null
        demoState.senderContext = null
        demoState.encapsulatedKey = null

        // Clear inputs and messages
        elements.ikmInput.value = ''
        clearMessages()

        // Reset key display elements to placeholder state
        setPlaceholder(elements.publicKeyOutput)
        setPlaceholder(elements.privateKeyOutput)
        setPlaceholder(elements.encapsulatedKeyOutput)
      }

      function resetContextState() {
        // Reset only context-related state, keep keys
        demoState.senderContext = null
        demoState.encapsulatedKey = null

        // Clear messages and reset encapsulated key display
        clearMessages()
        setPlaceholder(elements.encapsulatedKeyOutput)
      }

      async function updateDemoSection() {
        if (demoState.selectedKEM && demoState.selectedKDF && demoState.selectedAEAD) {
          elements.demoSection.classList.add('active')

          // Set theme class based on filter
          elements.demoSection.classList.remove('theme-noble', 'theme-both')
          if (onlyNoble) {
            elements.demoSection.classList.add('theme-noble')
          } else if (both) {
            elements.demoSection.classList.add('theme-both')
          }

          // Check if KEM has changed (only KEM affects key derivation)
          const kemChanged = !demoState.lastSelectedKEM ||
            demoState.selectedKEM.factory !== demoState.lastSelectedKEM

          // Check if any algorithm changed (affects context)
          const suiteChanged = kemChanged ||
            !demoState.lastSelectedKDF ||
            !demoState.lastSelectedAEAD ||
            demoState.selectedKDF.factory !== demoState.lastSelectedKDF ||
            demoState.selectedAEAD.factory !== demoState.lastSelectedAEAD

          // Store current selections
          demoState.lastSelectedKEM = demoState.selectedKEM.factory
          demoState.lastSelectedKDF = demoState.selectedKDF.factory
          demoState.lastSelectedAEAD = demoState.selectedAEAD.factory

          // Create new suite
          demoState.suite = new HPKE.CipherSuite(
            demoState.selectedKEM.factory,
            demoState.selectedKDF.factory,
            demoState.selectedAEAD.factory
          )

          // Only randomize IKM when KEM changes (KEM determines key size)
          if (kemChanged) {
            // Reset demo state when KEM changes
            resetDemoState()

            // Auto-generate random IKM and keypair
            const ikmLength = demoState.suite.KEM.Nsk
            const randomIkm = crypto.getRandomValues(new Uint8Array(ikmLength))
            elements.ikmInput.value = randomIkm.toHex()
            deriveFromIkm(randomIkm.toHex())
          } else if (suiteChanged) {
            // KDF/AEAD changed but KEM stayed the same - reset context, keep keys
            resetContextState()
            // Re-setup context with existing keys and new suite
            await setupSenderContext()
          }
        } else {
          elements.demoSection.classList.remove('active')
        }
      }

      // IKM button handlers
      document.getElementById('zeroIkmButton').addEventListener('click', async () => {
        if (!demoState.suite) return
        await deriveFromIkm(setZeroHex(elements.ikmInput, demoState.suite.KEM.Nsk).toHex())
      })

      document.getElementById('randomIkmButton').addEventListener('click', async () => {
        if (!demoState.suite) return
        await deriveFromIkm(setRandomHex(elements.ikmInput, demoState.suite.KEM.Nsk).toHex())
      })

      async function deriveFromIkm(ikmHex) {
        if (!demoState.suite) return

        if (!ikmHex) {
          // Empty IKM - show error and reset keys and context
          elements.ikmInput.classList.add('error')
          demoState.recipientKeyPair = null
          setPlaceholder(elements.publicKeyOutput)
          setPlaceholder(elements.privateKeyOutput)
          resetContextState()
          updateButtonStates()
          return
        }

        try {
          const ikm = Uint8Array.fromHex(ikmHex)
          demoState.recipientKeyPair = await demoState.suite.DeriveKeyPair(ikm, true)
          elements.ikmInput.classList.remove('error')

          // Show keys
          const publicKeyBytes = await demoState.suite.SerializePublicKey(demoState.recipientKeyPair.publicKey)
          elements.publicKeyOutput.textContent = publicKeyBytes.toHex()
          elements.publicKeyOutput.classList.remove('placeholder')

          if (demoState.recipientKeyPair.privateKey) {
            const privateKeyBytes = await demoState.suite.SerializePrivateKey(demoState.recipientKeyPair.privateKey)
            elements.privateKeyOutput.textContent = privateKeyBytes.toHex()
            elements.privateKeyOutput.classList.remove('placeholder')
            elements.privateKeyOutputGroup.classList.remove('hidden')
          } else {
            elements.privateKeyOutputGroup.classList.add('hidden')
          }

          await setupSenderContext()
        } catch (e) {
          // Highlight input field on error and reset keys
          elements.ikmInput.classList.add('error')
          demoState.recipientKeyPair = null
          setPlaceholder(elements.publicKeyOutput)
          setPlaceholder(elements.privateKeyOutput)
          resetContextState()
          console.error('Invalid IKM hex:', e.message)
        }
        updateButtonStates()
      }

      elements.ikmInput.addEventListener('input', async (e) => {
        await deriveFromIkm(e.target.value.trim())
      })

      // Mode selector
      document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', async (e) => {
          demoState.mode = e.target.value

          if (e.target.value === 'psk') {
            elements.pskFields.classList.remove('hidden')
            // Initialize PSK values if not present
            if (!elements.pskInput.value) {
              demoState.psk = setRandomHex(elements.pskInput, 32)
            } else {
              demoState.psk = validateHexInput(elements.pskInput, 32)
            }
            if (!elements.pskIdInput.value) {
              demoState.pskId = setRandomHex(elements.pskIdInput, 8)
            } else {
              demoState.pskId = validateHexInput(elements.pskIdInput, 1)
            }
          } else {
            elements.pskFields.classList.add('hidden')
            demoState.psk = demoState.pskId = null
          }

          await resetAndSetupContext()
        })
      })

      /** Creates input handler for hex fields that require non-empty in certain modes */
      const createHexInputHandler = (element, stateKey, minBytes = 0, requireNonEmpty = false) => {
        element.addEventListener('input', async (e) => {
          const value = e.target.value.trim()
          if (requireNonEmpty && !value) {
            e.target.classList.add('error')
            demoState[stateKey] = null
          } else {
            demoState[stateKey] = validateHexInput(e.target, minBytes)
          }
          await resetAndSetupContext()
          updateButtonStates()
        })
      }

      /** Creates button handler that sets random/zero value */
      const createHexButtonHandler = (buttonId, element, stateKey, byteCount, useZero = false) => {
        document.getElementById(buttonId).addEventListener('click', async () => {
          demoState[stateKey] = useZero ? setZeroHex(element, byteCount) : setRandomHex(element, byteCount)
          await resetAndSetupContext()
          updateButtonStates()
        })
      }

      // Info handlers
      createHexInputHandler(elements.infoInput, 'info')
      createHexButtonHandler('zeroInfoButton', elements.infoInput, 'info', 32, true)
      createHexButtonHandler('randomInfoButton', elements.infoInput, 'info', 32)

      // PSK handlers (require non-empty when in PSK mode)
      createHexInputHandler(elements.pskInput, 'psk', 32, true)
      createHexButtonHandler('randomPskButton', elements.pskInput, 'psk', 32)

      // PSK ID handlers (require non-empty when in PSK mode)
      createHexInputHandler(elements.pskIdInput, 'pskId', 1, true)
      createHexButtonHandler('randomPskIdButton', elements.pskIdInput, 'pskId', 8)

      async function setupSenderContext() {
        if (!demoState.suite || !demoState.recipientKeyPair) {
          resetContextState()
          return
        }

        // Check for any validation errors
        if (elements.infoInput.classList.contains('error')) {
          resetContextState()
          return
        }

        // PSK mode validation - both PSK and PSK ID are required and must be valid
        if (demoState.mode === 'psk') {
          const pskValue = elements.pskInput.value.trim()
          const pskIdValue = elements.pskIdInput.value.trim()

          // PSK is required and must be valid (>= 32 bytes)
          if (!pskValue) {
            elements.pskInput.classList.add('error')
            resetContextState()
            return
          }
          if (!demoState.psk) {
            resetContextState()
            return
          }

          // PSK ID is required and must be valid
          if (!pskIdValue) {
            elements.pskIdInput.classList.add('error')
            resetContextState()
            return
          }
          if (!demoState.pskId) {
            resetContextState()
            return
          }
        }

        try {
          // Setup sender context
          const options = {}
          if (demoState.info) options.info = demoState.info
          if (demoState.mode === 'psk') {
            options.psk = demoState.psk
            options.pskId = demoState.pskId
          }
          const result = await demoState.suite.SetupSender(demoState.recipientKeyPair.publicKey, options)
          demoState.senderContext = result.ctx
          demoState.encapsulatedKey = result.encapsulatedKey

          // Setup recipient context
          demoState.recipientContext = await demoState.suite.SetupRecipient(demoState.recipientKeyPair, result.encapsulatedKey, options)

          elements.encapsulatedKeyOutput.textContent = result.encapsulatedKey.toHex()
          elements.encapsulatedKeyOutput.classList.remove('placeholder')

          // Clear messages
          clearMessages()
        } catch (e) {
          console.error('Failed to setup context:', e.message)
          resetContextState()
        }
      }

      /** Creates and appends an encrypted message to the chat */
      function addEncryptedMessage(seq, plaintext, ciphertext, aad) {
        const ciphertextDiv = document.createElement('div')
        ciphertextDiv.className = 'chat-message ciphertext'
        ciphertextDiv.dataset.seq = seq
        ciphertextDiv.dataset.plaintext = plaintext.toHex()
        ciphertextDiv.dataset.ciphertext = ciphertext.toHex()
        ciphertextDiv.dataset.decrypted = 'false'
        if (aad) {
          ciphertextDiv.dataset.aad = aad.toHex()
        }

        // Update clickability based on whether this is the next message to decrypt
        const updateClickability = () => {
          const isNextToDecrypt = demoState.recipientContext.seq === seq
          if (isNextToDecrypt) {
            ciphertextDiv.classList.add('clickable')
            ciphertextDiv.classList.remove('not-clickable')
          } else {
            ciphertextDiv.classList.add('not-clickable')
            ciphertextDiv.classList.remove('clickable')
          }
        }

        updateClickability()

        ciphertextDiv.innerHTML = `
          <div class="chat-message-label">Ciphertext ${seq}</div>
          ${aad ? `<div class="chat-message-label">AAD: ${aad.toHex()}</div>` : ''}
          <div class="chat-message-content">${ciphertext.toHex()}</div>
        `

        // Add click handler to decrypt
        ciphertextDiv.addEventListener('click', async function() {
          if (this.dataset.decrypted === 'true') return

          // Check if this is the next message in sequence
          if (demoState.recipientContext.seq !== seq) {
            return
          }

          try {
            const ciphertextBytes = Uint8Array.fromHex(this.dataset.ciphertext)
            const aad = this.dataset.aad ? Uint8Array.fromHex(this.dataset.aad) : null
            const decrypted = await demoState.recipientContext.Open(ciphertextBytes, aad)
            const plaintext = new TextDecoder().decode(decrypted)

            // Replace ciphertext with plaintext
            this.innerHTML = `
              <div class="chat-message-label">Plaintext ${seq}</div>
              ${this.dataset.aad ? `<div class="chat-message-label">AAD: ${this.dataset.aad}</div>` : ''}
              <div class="chat-message-content">${plaintext}</div>
            `
            this.classList.remove('ciphertext')
            this.classList.add('decrypted')
            this.classList.remove('clickable', 'not-clickable')
            this.dataset.decrypted = 'true'

            // Scroll this plaintext message to top of chat container with margin
            const offsetTop = this.offsetTop - elements.chatContainer.offsetTop - 15
            elements.chatContainer.scrollTo({ top: offsetTop, behavior: 'smooth' })

            // Update clickability of all remaining ciphertexts
            elements.chatContainer.querySelectorAll('.chat-message.ciphertext').forEach(div => {
              if (div.dataset.decrypted === 'false') {
                const divSeq = parseInt(div.dataset.seq)
                const isNextToDecrypt = demoState.recipientContext.seq === divSeq
                if (isNextToDecrypt) {
                  div.classList.add('clickable')
                  div.classList.remove('not-clickable')
                } else {
                  div.classList.add('not-clickable')
                  div.classList.remove('clickable')
                }
              }
            })
          } catch (e) {
            console.error('Error decrypting:', e)
            alert('Error decrypting message: ' + e.message)
          }
        })

        elements.chatContainer.appendChild(ciphertextDiv)
        elements.messagesDisplaySection.classList.remove('hidden')
      }

      // Message sending
      async function sendMessage() {
        if (!demoState.senderContext) {
          console.error('No sender context available')
          return
        }

        const message = elements.messageInput.value.trim()
        if (!message) return

        // Check if AEAD is export-only mode
        if (demoState.selectedAEAD.name === 'AEAD_EXPORT_ONLY') {
          alert('Cannot send messages in Export-Only mode. Please select a different AEAD.')
          return
        }

        // Check for any invalid fields
        if (hasValidationErrors()) {
          return
        }

        try {
          // Get sequence number BEFORE sealing
          const seq = demoState.senderContext.seq

          // Get AAD if provided
          let aad = null
          if (elements.aadInput.value.trim()) {
            aad = Uint8Array.fromHex(elements.aadInput.value.trim())
          }

          // Encrypt message
          const plaintext = new TextEncoder().encode(message)
          const ciphertext = await demoState.senderContext.Seal(plaintext, aad)

          // Add encrypted message to chat
          addEncryptedMessage(seq, plaintext, ciphertext, aad)

          // Clear inputs
          elements.messageInput.value = ''
          elements.aadInput.value = ''
          updateButtonStates()
        } catch (e) {
          console.error('Error sending message:', e)
          alert('Error encrypting message: ' + e.message)
        }
      }

      /** Update button states based on input validity and messages */
      const updateButtonStates = () => {
        const hasErrors = hasValidationErrors()

        elements.sendButton.disabled = !elements.messageInput.value.trim() || hasErrors
        elements.autoPopulateButton.disabled = hasErrors

        const hasMessages = elements.chatContainer.children.length > 0

        // Enable download button if we have a valid suite and messages
        elements.downloadVectorBtn.disabled = !demoState.suite || !hasMessages || hasErrors
      }

      // Initialize button states
      updateButtonStates()

      // Update button states on input
      elements.messageInput.addEventListener('input', updateButtonStates)

      elements.sendButton.addEventListener('click', (e) => {
        e.preventDefault()
        sendMessage()
      })
      elements.messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault()
          sendMessage()
        }
      })

      elements.aadInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault()
          sendMessage()
        }
      })

      // Validate AAD input on change
      elements.aadInput.addEventListener('input', () => {
        validateHexInput(elements.aadInput)
        updateButtonStates()
      })

      // Download vector button handler
      elements.downloadVectorBtn.addEventListener('click', async () => {
        if (!demoState.suite || !demoState.recipientKeyPair) return

        const messages = elements.chatContainer.querySelectorAll('.chat-message')
        if (messages.length === 0) return

        // Collect encryptions from chat messages
        const encryptions = []
        for (const msg of messages) {
          const pt = msg.dataset.plaintext || ''
          const aad = msg.dataset.aad || ''
          const ct = msg.dataset.ciphertext
          encryptions.push({ pt, aad, ct })
        }

        // Get algorithm IDs
        const kemId = ALGORITHM_IDS[demoState.selectedKEM.name]
        const kdfId = ALGORITHM_IDS[demoState.selectedKDF.name]
        const aeadId = ALGORITHM_IDS[demoState.selectedAEAD.name]

        // Get mode (0x00 for base, 0x01 for PSK)
        const mode = demoState.mode === 'psk' ? 0x01 : 0x00

        // Serialize keys
        const ikmR = await demoState.suite.SerializePrivateKey(demoState.recipientKeyPair.privateKey)
        const pkRm = await demoState.suite.SerializePublicKey(demoState.recipientKeyPair.publicKey)
        const skRm = ikmR // Same for derived keys

        // Build vector object
        const vector = {
          mode,
          kem_id: kemId,
          kdf_id: kdfId,
          aead_id: aeadId,
          info: demoState.info ? demoState.info.toHex() : '',
          ikmR: ikmR.toHex(),
          pkRm: pkRm.toHex(),
          skRm: skRm.toHex(),
          enc: demoState.encapsulatedKey.toHex(),
          encryptions
        }

        // Add PSK fields if in PSK mode
        if (mode === 0x01) {
          vector.psk = demoState.psk.toHex()
          vector.psk_id = demoState.pskId.toHex()
        }

        // Create filename
        const kemName = demoState.selectedKEM.name
        const kdfName = demoState.selectedKDF.name
        const aeadName = demoState.selectedAEAD.name
        const filename = `hpke-vector-${kemName}-${kdfName}-${aeadName}.json`

        // Download file
        const blob = new Blob([JSON.stringify([vector], null, 2)], { type: 'application/json' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = filename
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      })

      // Auto-populate with random public domain text
      elements.autoPopulateButton.addEventListener('click', async (e) => {
        e.preventDefault()

        if (!demoState.senderContext) {
          alert('Please select algorithms and generate a key pair first.')
          return
        }

        if (demoState.selectedAEAD.name === 'AEAD_EXPORT_ONLY') {
          alert('Cannot send messages in Export-Only mode. Please select a different AEAD.')
          return
        }

        // Check for any invalid fields
        if (hasValidationErrors()) {
          return
        }

        // Validate PSK mode requirements
        if (demoState.mode === 'psk' && (!demoState.psk || !demoState.pskId)) {
          alert('PSK mode requires both PSK and PSK ID')
          return
        }

        // Clear existing messages and reset contexts with same keys
        elements.chatContainer.innerHTML = ''

        // Setup fresh sender and recipient contexts
        const options = {}
        if (demoState.info) options.info = demoState.info
        if (demoState.mode === 'psk') {
          options.psk = demoState.psk
          options.pskId = demoState.pskId
        }
        const result = await demoState.suite.SetupSender(demoState.recipientKeyPair.publicKey, options)
        demoState.senderContext = result.ctx
        demoState.encapsulatedKey = result.encapsulatedKey

        demoState.recipientContext = await demoState.suite.SetupRecipient(demoState.recipientKeyPair, result.encapsulatedKey, options)

        elements.encapsulatedKeyOutput.textContent = result.encapsulatedKey.toHex()

        const publicDomainTexts = [
          [
            "The Raven by Edgar Allan Poe",
            "Once upon a midnight dreary, while I pondered, weak and weary,",
            "Over many a quaint and curious volume of forgotten lore—",
            "While I nodded, nearly napping, suddenly there came a tapping,",
            "As of some one gently rapping, rapping at my chamber door.",
            "'Tis some visitor,' I muttered, 'tapping at my chamber door—",
            "Only this and nothing more.'",
            "Ah, distinctly I remember it was in the bleak December;",
            "And each separate dying ember wrought its ghost upon the floor.",
            "Eagerly I wished the morrow;—vainly I had sought to borrow",
            "From my books surcease of sorrow—sorrow for the lost Lenore—",
            "For the rare and radiant maiden whom the angels name Lenore—",
            "Nameless here for evermore."
          ],
          [
            "A Tale of Two Cities by Charles Dickens",
            "It was the best of times, it was the worst of times,",
            "it was the age of wisdom, it was the age of foolishness,",
            "it was the epoch of belief, it was the epoch of incredulity,",
            "it was the season of Light, it was the season of Darkness,",
            "it was the spring of hope, it was the winter of despair,",
            "we had everything before us, we had nothing before us,",
            "we were all going direct to Heaven,",
            "we were all going direct the other way—",
            "in short, the period was so far like the present period,",
            "that some of its noisiest authorities insisted on its being received,",
            "for good or for evil, in the superlative degree of comparison only."
          ],
          [
            "Moby Dick by Herman Melville",
            "Call me Ishmael.",
            "Some years ago—never mind how long precisely—",
            "having little or no money in my purse,",
            "and nothing particular to interest me on shore,",
            "I thought I would sail about a little",
            "and see the watery part of the world.",
            "It is a way I have of driving off the spleen",
            "and regulating the circulation.",
            "Whenever I find myself growing grim about the mouth;",
            "whenever it is a damp, drizzly November in my soul;",
            "whenever I find myself involuntarily pausing before coffin warehouses,",
            "and bringing up the rear of every funeral I meet;"
          ],
          [
            "Pride and Prejudice by Jane Austen",
            "It is a truth universally acknowledged,",
            "that a single man in possession of a good fortune,",
            "must be in want of a wife.",
            "However little known the feelings or views of such a man may be",
            "on his first entering a neighbourhood,",
            "this truth is so well fixed in the minds of the surrounding families,",
            "that he is considered the rightful property",
            "of some one or other of their daughters.",
            "'My dear Mr. Bennet,' said his lady to him one day,",
            "'have you heard that Netherfield Park is let at last?'",
            "Mr. Bennet replied that he had not.",
            "'But it is,' returned she; 'for Mrs. Long has just been here,'"
          ],
          [
            "The Great Gatsby by F. Scott Fitzgerald",
            "In my younger and more vulnerable years",
            "my father gave me some advice that I've been turning over in my mind ever since.",
            "'Whenever you feel like criticizing any one,' he told me,",
            "'just remember that all the people in this world",
            "haven't had the advantages that you've had.'",
            "He didn't say any more, but we've always been unusually communicative",
            "in a reserved way, and I understood",
            "that he meant a great deal more than that.",
            "In consequence, I'm inclined to reserve all judgments,",
            "a habit that has opened up many curious natures to me",
            "and also made me the victim of not a few veteran bores."
          ],
          [
            "Frankenstein by Mary Shelley",
            "You will rejoice to hear that no disaster has accompanied",
            "the commencement of an enterprise which you have regarded with such evil forebodings.",
            "I arrived here yesterday, and my first task is to assure my dear sister",
            "of my welfare and increasing confidence in the success of my undertaking.",
            "I am already far north of London,",
            "and as I walk in the streets of Petersburgh,",
            "I feel a cold northern breeze play upon my cheeks,",
            "which braces my nerves and fills me with delight.",
            "Do you understand this feeling?",
            "This breeze, which has travelled from the regions towards which I am advancing,",
            "gives me a foretaste of those icy climes."
          ],
          [
            "Alice's Adventures in Wonderland by Lewis Carroll",
            "Alice was beginning to get very tired",
            "of sitting by her sister on the bank,",
            "and of having nothing to do:",
            "once or twice she had peeped into the book her sister was reading,",
            "but it had no pictures or conversations in it,",
            "'and what is the use of a book,' thought Alice",
            "'without pictures or conversations?'",
            "So she was considering in her own mind",
            "(as well as she could, for the hot day made her feel very sleepy and stupid),",
            "whether the pleasure of making a daisy-chain",
            "would be worth the trouble of getting up and picking the daisies,"
          ],
          [
            "The Adventures of Sherlock Holmes by Arthur Conan Doyle",
            "To Sherlock Holmes she is always the woman.",
            "I have seldom heard him mention her under any other name.",
            "In his eyes she eclipses and predominates",
            "the whole of her sex.",
            "It was not that he felt any emotion akin to love for Irene Adler.",
            "All emotions, and that one particularly,",
            "were abhorrent to his cold, precise but admirably balanced mind.",
            "He was, I take it, the most perfect reasoning and observing machine",
            "that the world has seen,",
            "but as a lover he would have placed himself in a false position.",
            "He never spoke of the softer passions, save with a gibe and a sneer."
          ],
          [
            "The Picture of Dorian Gray by Oscar Wilde",
            "The studio was filled with the rich odour of roses,",
            "and when the light summer wind stirred amidst the trees of the garden,",
            "there came through the open door the heavy scent of the lilac,",
            "or the more delicate perfume of the pink-flowering thorn.",
            "From the corner of the divan of Persian saddle-bags",
            "on which he was lying, smoking, as was his custom,",
            "innumerable cigarettes, Lord Henry Wotton",
            "could just catch the gleam of the honey-sweet and honey-coloured blossoms",
            "of a laburnum, whose tremulous branches seemed hardly able",
            "to bear the burden of a beauty so flamelike as theirs;"
          ],
          [
            "Dracula by Bram Stoker",
            "3 May. Bistritz.—Left Munich at 8:35 P.M.,",
            "on 1st May, arriving at Vienna early next morning;",
            "should have arrived at 6:46, but train was an hour late.",
            "Buda-Pesth seems a wonderful place,",
            "from the glimpse which I got of it from the train",
            "and the little I could walk through the streets.",
            "I feared to go very far from the station,",
            "as we had arrived late and would start as near the correct time as possible.",
            "The impression I had was that we were leaving the West",
            "and entering the East;",
            "the most western of splendid bridges over the Danube,"
          ],
          [
            "The Time Machine by H.G. Wells",
            "The Time Traveller (for so it will be convenient to speak of him)",
            "was expounding a recondite matter to us.",
            "His grey eyes shone and twinkled,",
            "and his usually pale face was flushed and animated.",
            "The fire burned brightly,",
            "and the soft radiance of the incandescent lights",
            "in the lilies of silver caught the bubbles",
            "that flashed and passed in our glasses.",
            "Our chairs, being his patents, embraced and caressed us",
            "rather than submitted to be sat upon,",
            "and there was that luxurious after-dinner atmosphere"
          ],
          [
            "The Metamorphosis by Franz Kafka",
            "One morning, when Gregor Samsa woke from troubled dreams,",
            "he found himself transformed in his bed into a horrible vermin.",
            "He lay on his armour-like back,",
            "and if he lifted his head a little",
            "he could see his brown belly, slightly domed",
            "and divided by arches into stiff sections.",
            "The bedding was hardly able to cover it",
            "and seemed ready to slide off any moment.",
            "His many legs, pitifully thin compared with the size of the rest of him,",
            "waved about helplessly as he looked.",
            "'What's happened to me?' he thought."
          ],
          [
            "The Jungle Book by Rudyard Kipling",
            "It was seven o'clock of a very warm evening in the Seeonee hills",
            "when Father Wolf woke up from his day's rest,",
            "scratched himself, yawned, and spread out his paws",
            "one after the other to get rid of the sleepy feeling in their tips.",
            "Mother Wolf lay with her big gray nose",
            "dropped across her four tumbling, squealing cubs,",
            "and the moon shone into the mouth of the cave where they all lived.",
            "'Augrh!' said Father Wolf. 'It is time to hunt again.'",
            "He was going to spring down hill",
            "when a little shadow with a bushy tail crossed the threshold",
            "and whined: 'Good luck go with you, O Chief of the Wolves.'"
          ],
          [
            "The Strange Case of Dr Jekyll and Mr Hyde by Robert Louis Stevenson",
            "Mr. Utterson the lawyer was a man of a rugged countenance",
            "that was never lighted by a smile;",
            "cold, scanty and embarrassed in discourse;",
            "backward in sentiment; lean, long, dusty, dreary",
            "and yet somehow lovable.",
            "At friendly meetings, and when the wine was to his taste,",
            "something eminently human beaconed from his eye;",
            "something indeed which never found its way into his talk,",
            "but which spoke not only in these silent symbols of the after-dinner face,",
            "but more often and loudly in the acts of his life."
          ],
          [
            "Twenty Thousand Leagues Under the Sea by Jules Verne",
            "The year 1866 was signalised by a remarkable incident,",
            "a mysterious and puzzling phenomenon,",
            "which doubtless no one has yet forgotten.",
            "Not to mention rumours which agitated the maritime population",
            "and excited the public mind, even in the interior of continents,",
            "seafaring men were particularly excited.",
            "Merchants, common sailors, captains of vessels, skippers,",
            "both of Europe and America, naval officers of all countries,",
            "and the Governments of several States on the two continents,",
            "were deeply interested in the matter."
          ],
          [
            "The War of the Worlds by H.G. Wells",
            "No one would have believed in the last years of the nineteenth century",
            "that this world was being watched keenly and closely",
            "by intelligences greater than man's and yet as mortal as his own;",
            "that as men busied themselves about their various concerns",
            "they were scrutinised and studied,",
            "perhaps almost as narrowly as a man with a microscope",
            "might scrutinise the transient creatures",
            "that swarm and multiply in a drop of water.",
            "With infinite complacency men went to and fro over this globe",
            "about their little affairs, serene in their assurance",
            "of their empire over matter."
          ],
          [
            "The Count of Monte Cristo by Alexandre Dumas",
            "On the 24th of February, 1815,",
            "the look-out at Notre-Dame de la Garde signalled",
            "the three-master, the Pharaon from Smyrna, Trieste, and Naples.",
            "As usual, a pilot put off immediately,",
            "and rounding the Château d'If,",
            "got on board the vessel between Cape Morgiou and Rion island.",
            "Immediately, and according to custom,",
            "the ramparts of Fort Saint-Jean were covered with spectators;",
            "it is always an event at Marseilles for a ship to come into port,",
            "especially when this ship, like the Pharaon,",
            "has been built, rigged, and laden at the old Phocée docks,"
          ],
          [
            "Wuthering Heights by Emily Brontë",
            "1801.—I have just returned from a visit to my landlord—",
            "the solitary neighbour that I shall be troubled with.",
            "This is certainly a beautiful country!",
            "In all England, I do not believe that I could have fixed",
            "on a situation so completely removed from the stir of society.",
            "A perfect misanthropist's heaven:",
            "and Mr. Heathcliff and I are such a suitable pair",
            "to divide the desolation between us.",
            "A capital fellow!",
            "He little imagined how my heart warmed towards him",
            "when I beheld his black eyes withdraw so suspiciously under their brows,"
          ],
          [
            "Anna Karenina by Leo Tolstoy",
            "All happy families are alike;",
            "each unhappy family is unhappy in its own way.",
            "Everything was in confusion in the Oblonskys' house.",
            "The wife had discovered that the husband was carrying on an intrigue",
            "with a French girl, who had been a governess in their family,",
            "and she had announced to her husband",
            "that she could not go on living in the same house with him.",
            "This position of affairs had now lasted three days,",
            "and not only the husband and wife themselves,",
            "but all the members of their family and household, were painfully conscious of it."
          ],
          [
            "The Odyssey by Homer (Samuel Butler translation)",
            "Tell me, O muse, of that ingenious hero",
            "who travelled far and wide after he had sacked",
            "the famous town of Troy.",
            "Many cities did he visit, and many were the nations",
            "with whose manners and customs he was acquainted;",
            "moreover he suffered much by sea",
            "while trying to save his own life",
            "and bring his men safely home;",
            "but do what he might he could not save his men,",
            "for they perished through their own sheer folly",
            "in eating the cattle of the Sun-god Hyperion;"
          ],
          [
            "The Iliad by Homer (Samuel Butler translation)",
            "Sing, O goddess, the anger of Achilles son of Peleus,",
            "that brought countless ills upon the Achaeans.",
            "Many a brave soul did it send hurrying down to Hades,",
            "and many a hero did it yield a prey to dogs and vultures,",
            "for so were the counsels of Jove fulfilled",
            "from the day on which the son of Atreus, king of men,",
            "and great Achilles, first fell out with one another.",
            "And which of the gods was it that set them on to quarrel?",
            "It was the son of Jove and Leto;",
            "for he was angry with the king",
            "and sent a pestilence upon the host to plague the people,"
          ],
          [
            "Don Quixote by Miguel de Cervantes",
            "In a village of La Mancha, the name of which I have no desire to call to mind,",
            "there lived not long since one of those gentlemen",
            "that keep a lance in the lance-rack,",
            "an old buckler, a lean hack, and a greyhound for coursing.",
            "An olla of rather more beef than mutton,",
            "a salad on most nights, scraps on Saturdays,",
            "lentils on Fridays, and a pigeon or so extra on Sundays,",
            "made away with three-quarters of his income.",
            "The rest of it went in a doublet of fine cloth",
            "and velvet breeches and shoes to match for holidays,",
            "while on week-days he made a brave figure in his best homespun."
          ],
          [
            "The Divine Comedy by Dante Alighieri (Longfellow translation)",
            "Midway upon the journey of our life",
            "I found myself within a forest dark,",
            "For the straightforward pathway had been lost.",
            "Ah me! how hard a thing it is to say",
            "What was this forest savage, rough, and stern,",
            "Which in the very thought renews the fear.",
            "So bitter is it, death is little more;",
            "But of the good to treat, which there I found,",
            "Speak will I of the other things I saw there.",
            "I cannot well repeat how there I entered,",
            "So full was I of slumber at the moment"
          ],
          [
            "Gulliver's Travels by Jonathan Swift",
            "My father had a small estate in Nottinghamshire:",
            "I was the third of five sons.",
            "He sent me to Emanuel College in Cambridge at fourteen years old,",
            "where I resided three years, and applied myself close to my studies;",
            "but the charge of maintaining me,",
            "although I had a very scanty allowance,",
            "being too great for a narrow fortune,",
            "I was bound apprentice to Mr. James Bates,",
            "an eminent surgeon in London,",
            "with whom I continued four years.",
            "My father now and then sending me small sums of money,"
          ],
          [
            "Robinson Crusoe by Daniel Defoe",
            "I was born in the year 1632, in the city of York,",
            "of a good family, though not of that country,",
            "my father being a foreigner of Bremen,",
            "who settled first at Hull.",
            "He got a good estate by merchandise,",
            "and leaving off his trade, lived afterwards at York,",
            "from whence he had married my mother,",
            "whose relations were named Robinson,",
            "a very good family in that country,",
            "and from whom I was called Robinson Kreutznaer;",
            "but, by the usual corruption of words in England,"
          ],
          [
            "The Three Musketeers by Alexandre Dumas",
            "On the first Monday of the month of April, 1625,",
            "the market town of Meung, in which the author of ROMANCE OF THE ROSE was born,",
            "appeared to be in as perfect a state of revolution",
            "as if the Huguenots had just made a second La Rochelle of it.",
            "Many citizens, seeing the women flying toward the High Street,",
            "leaving their children crying at the open doors,",
            "hastened to don the cuirass,",
            "and supporting their somewhat uncertain courage",
            "with a musket or a partisan,",
            "directed their steps toward the hostelry of the Jolly Miller,",
            "before which was gathered, increasing every minute, a compact group,"
          ],
          [
            "The Scarlet Letter by Nathaniel Hawthorne",
            "A throng of bearded men, in sad-coloured garments",
            "and grey steeple-crowned hats, inter-mixed with women,",
            "some wearing hoods, and others bareheaded,",
            "was assembled in front of a wooden edifice,",
            "the door of which was heavily timbered with oak,",
            "and studded with iron spikes.",
            "The founders of a new colony, whatever Utopia of human virtue",
            "and happiness they might originally project,",
            "have invariably recognised it among their earliest practical necessities",
            "to allot a portion of the virgin soil as a cemetery,",
            "and another portion as the site of a prison."
          ],
          [
            "Heart of Darkness by Joseph Conrad",
            "The Nellie, a cruising yawl, swung to her anchor",
            "without a flutter of the sails, and was at rest.",
            "The flood had made, the wind was nearly calm,",
            "and being bound down the river,",
            "the only thing for it was to come to and wait for the turn of the tide.",
            "The sea-reach of the Thames stretched before us",
            "like the beginning of an interminable waterway.",
            "In the offing the sea and the sky were welded together",
            "without a joint, and in the luminous space",
            "the tanned sails of the barges drifting up with the tide",
            "seemed to stand still in red clusters of canvas"
          ],
          [
            "The Adventures of Tom Sawyer by Mark Twain",
            "'Tom!'",
            "No answer.",
            "'Tom!'",
            "No answer.",
            "'What's gone with that boy, I wonder? You TOM!'",
            "No answer.",
            "The old lady pulled her spectacles down",
            "and looked over them about the room;",
            "then she put them up and looked out under them.",
            "She seldom or never looked through them",
            "for so small a thing as a boy;"
          ],
          [
            "The Wonderful Wizard of Oz by L. Frank Baum",
            "Dorothy lived in the midst of the great Kansas prairies,",
            "with Uncle Henry, who was a farmer,",
            "and Aunt Em, who was the farmer's wife.",
            "Their house was small,",
            "for the lumber to build it had to be carried by wagon many miles.",
            "There were four walls, a floor and a roof,",
            "which made one room;",
            "and this room contained a rusty looking cookstove,",
            "a cupboard for the dishes, a table, three or four chairs,",
            "and the beds.",
            "Uncle Henry and Aunt Em had a big bed in one corner,"
          ],
          [
            "Treasure Island by Robert Louis Stevenson",
            "Squire Trelawney, Dr. Livesey, and the rest of these gentlemen",
            "having asked me to write down the whole particulars about Treasure Island,",
            "from the beginning to the end,",
            "keeping nothing back but the bearings of the island,",
            "and that only because there is still treasure not yet lifted,",
            "I take up my pen in the year of grace 17—",
            "and go back to the time when my father kept the Admiral Benbow inn",
            "and the brown old seaman with the sabre cut",
            "first took up his lodging under our roof.",
            "I remember him as if it were yesterday,",
            "as he came plodding to the inn door,"
          ],
          [
            "The Republic by Plato (Jowett translation)",
            "I went down yesterday to the Piraeus",
            "with Glaucon the son of Ariston,",
            "that I might offer up my prayers to the goddess;",
            "and also because I wanted to see",
            "in what manner they would celebrate the festival,",
            "which was a new thing.",
            "I was delighted with the procession of the inhabitants;",
            "but that of the Thracians was equally, if not more, beautiful.",
            "When we had finished our prayers and viewed the spectacle,",
            "we turned in the direction of the city;",
            "and at that instant Polemarchus the son of Cephalus chanced to catch sight of us"
          ],
          [
            "The Prince by Niccolò Machiavelli",
            "All states, all powers, that have held and hold rule over men",
            "have been and are either republics or principalities.",
            "Principalities are either hereditary,",
            "in which the family has been long established;",
            "or they are new.",
            "The new are either entirely new,",
            "as was Milan to Francesco Sforza,",
            "or they are, as it were, members annexed",
            "to the hereditary state of the prince who has acquired them,",
            "as was the kingdom of Naples to that of the King of Spain."
          ],
          [
            "Meditations by Marcus Aurelius (Long translation)",
            "From my grandfather Verus I learned good morals and the government of my temper.",
            "From the reputation and remembrance of my father, modesty and a manly character.",
            "From my mother, piety and beneficence,",
            "and abstinence, not only from evil deeds, but even from evil thoughts;",
            "and further, simplicity in my way of living,",
            "far removed from the habits of the rich.",
            "From my great-grandfather, not to have frequented public schools,",
            "and to have had good teachers at home,",
            "and to know that on such things a man should spend liberally."
          ],
          [
            "The Art of War by Sun Tzu (Giles translation)",
            "Sun Tzu said: The art of war is of vital importance to the State.",
            "It is a matter of life and death,",
            "a road either to safety or to ruin.",
            "Hence it is a subject of inquiry which can on no account be neglected.",
            "The art of war, then, is governed by five constant factors,",
            "to be taken into account in one's deliberations,",
            "when seeking to determine the conditions obtaining in the field.",
            "These are: (1) The Moral Law; (2) Heaven; (3) Earth; (4) The Commander; (5) Method and discipline.",
            "The Moral Law causes the people to be in complete accord with their ruler,",
            "so that they will follow him regardless of their lives,",
            "undismayed by any danger."
          ],
          [
            "Leaves of Grass by Walt Whitman",
            "I celebrate myself, and sing myself,",
            "And what I assume you shall assume,",
            "For every atom belonging to me as good belongs to you.",
            "I loafe and invite my soul,",
            "I lean and loafe at my ease observing a spear of summer grass.",
            "My tongue, every atom of my blood, form'd from this soil, this air,",
            "Born here of parents born here from parents the same, and their parents the same,",
            "I, now thirty-seven years old in perfect health begin,",
            "Hoping to cease not till death.",
            "Creeds and schools in abeyance,",
            "Retiring back a while sufficed at what they are, but never forgotten,"
          ],
          [
            "Paradise Lost by John Milton",
            "Of Man's first disobedience, and the fruit",
            "Of that forbidden tree whose mortal taste",
            "Brought death into the World, and all our woe,",
            "With loss of Eden, till one greater Man",
            "Restore us, and regain the blissful Seat,",
            "Sing, Heavenly Muse, that, on the secret top",
            "Of Oreb, or of Sinai, didst inspire",
            "That shepherd who first taught the chosen seed",
            "In the beginning how the heavens and earth",
            "Rose out of Chaos: or, if Sion hill",
            "Delight thee more, and Siloa's brook that flowed"
          ],
          [
            "Beowulf (Hall translation)",
            "Lo! the Spear-Danes' glory through splendid achievements",
            "The folk-kings' former fame we have heard of,",
            "How princes displayed then their prowess-in-battle.",
            "Oft Scyld the Scefing from scathers in numbers",
            "From many a people their mead-benches tore.",
            "Since first he found him friendless and wretched,",
            "The earl had had terror: comfort he got for it,",
            "Waxed 'neath the welkin, world-honor gained,",
            "Till all his neighbors o'er sea were compelled to",
            "Bow to his bidding and bring him their tribute:",
            "An excellent atheling!"
          ],
          [
            "The Canterbury Tales by Geoffrey Chaucer (Modern English)",
            "When April with his showers sweet with fruit",
            "The drought of March has pierced unto the root",
            "And bathed each vein with liquor that has power",
            "To generate therein and sire the flower;",
            "When Zephyr also has, with his sweet breath,",
            "Quickened again, in every holt and heath,",
            "The tender shoots and buds, and the young sun",
            "Into the Ram one half his course has run,",
            "And many little birds make melody",
            "That sleep through all the night with open eye",
            "(So Nature pricks them on to ramp and rage)"
          ],
          [
            "The Declaration of Independence",
            "When in the Course of human events,",
            "it becomes necessary for one people",
            "to dissolve the political bands",
            "which have connected them with another,",
            "and to assume among the powers of the earth,",
            "the separate and equal station",
            "to which the Laws of Nature and of Nature's God entitle them,",
            "a decent respect to the opinions of mankind",
            "requires that they should declare the causes",
            "which impel them to the separation."
          ],
          [
            "The Communist Manifesto by Karl Marx and Friedrich Engels",
            "A spectre is haunting Europe—the spectre of communism.",
            "All the powers of old Europe have entered into a holy alliance",
            "to exorcise this spectre:",
            "Pope and Tsar, Metternich and Guizot,",
            "French Radicals and German police-spies.",
            "Where is the party in opposition that has not been decried as communistic",
            "by its opponents in power?",
            "Where is the opposition that has not hurled back",
            "the branding reproach of communism,",
            "against the more advanced opposition parties,",
            "as well as against its reactionary adversaries?"
          ],
          [
            "Common Sense by Thomas Paine",
            "Perhaps the sentiments contained in the following pages,",
            "are not yet sufficiently fashionable to procure them general favour;",
            "a long habit of not thinking a thing wrong,",
            "gives it a superficial appearance of being right,",
            "and raises at first a formidable outcry in defense of custom.",
            "But the tumult soon subsides.",
            "Time makes more converts than reason.",
            "As a long and violent abuse of power,",
            "is generally the Means of calling the right of it in question",
            "(and in Matters too which might never have been thought of,",
            "had not the Sufferers been aggravated into the inquiry)"
          ],
          [
            "Walden by Henry David Thoreau",
            "When I wrote the following pages, or rather the bulk of them,",
            "I lived alone, in the woods,",
            "a mile from any neighbor,",
            "in a house which I had built myself,",
            "on the shore of Walden Pond, in Concord, Massachusetts,",
            "and earned my living by the labor of my hands only.",
            "I lived there two years and two months.",
            "At present I am a sojourner in civilized life again.",
            "I should not obtrude my affairs so much on the notice of my readers",
            "if very particular inquiries had not been made by my townsmen",
            "concerning my mode of life,"
          ],
          [
            "Civil Disobedience by Henry David Thoreau",
            "I heartily accept the motto,",
            "'That government is best which governs least;'",
            "and I should like to see it acted up to more rapidly and systematically.",
            "Carried out, it finally amounts to this,",
            "which also I believe—",
            "'That government is best which governs not at all;'",
            "and when men are prepared for it, that will be the kind of government",
            "which they will have.",
            "Government is at best but an expedient;",
            "but most governments are usually, and all governments are sometimes, inexpedient."
          ],
          [
            "The Federalist Papers (No. 10) by James Madison",
            "Among the numerous advantages promised by a well-constructed Union,",
            "none deserves to be more accurately developed",
            "than its tendency to break and control the violence of faction.",
            "The friend of popular governments never finds himself",
            "so much alarmed for their character and fate,",
            "as when he contemplates their propensity to this dangerous vice.",
            "He will not fail, therefore, to set a due value",
            "on any plan which, without violating the principles to which he is attached,",
            "provides a proper cure for it.",
            "The instability, injustice, and confusion",
            "introduced into the public councils,"
          ],
          [
            "The Souls of Black Folk by W.E.B. Du Bois",
            "Between me and the other world there is ever an unasked question:",
            "unasked by some through feelings of delicacy;",
            "by others through the difficulty of rightly framing it.",
            "All, nevertheless, flutter round it.",
            "They approach me in a half-hesitant sort of way,",
            "eye me curiously or compassionately,",
            "and then, instead of saying directly,",
            "How does it feel to be a problem?",
            "they say, I know an excellent colored man in my town;",
            "or, I fought at Mechanicsville;",
            "or, Do not these Southern outrages make your blood boil?"
          ],
          [
            "A Room of One's Own by Virginia Woolf",
            "But, you may say, we asked you to speak about women and fiction—",
            "what has that got to do with a room of one's own?",
            "I will try to explain.",
            "When you asked me to speak about women and fiction",
            "I sat down on the banks of a river and began to wonder",
            "what the words meant.",
            "They might mean simply a few remarks about Fanny Burney;",
            "a few more about Jane Austen;",
            "a tribute to the Brontës and a sketch of Haworth Parsonage under snow;",
            "some witticisms if possible about Miss Mitford;",
            "a respectful allusion to George Eliot;"
          ],
          [
            "Narrative of the Life of Frederick Douglass",
            "I was born in Tuckahoe, near Hillsborough,",
            "and about twelve miles from Easton, in Talbot county, Maryland.",
            "I have no accurate knowledge of my age,",
            "never having seen any authentic record containing it.",
            "By far the larger part of the slaves",
            "know as little of their ages as horses know of theirs,",
            "and it is the wish of most masters within my knowledge",
            "to keep their slaves thus ignorant.",
            "I do not remember to have ever met a slave",
            "who could tell of his birthday."
          ],
          [
            "Up From Slavery by Booker T. Washington",
            "I was born a slave on a plantation in Franklin County, Virginia.",
            "I am not quite sure of the exact place or exact date of my birth,",
            "but at any rate I suspect I must have been born",
            "somewhere and at some time.",
            "As nearly as I have been able to learn,",
            "I was born near a cross-roads post-office called Hale's Ford,",
            "and the year was 1858 or 1859.",
            "I do not know the month or the day.",
            "The earliest impressions I can now recall",
            "are of the plantation and the slave quarters—",
            "the latter being the part of the plantation"
          ],
          [
            "The Yellow Wallpaper by Charlotte Perkins Gilman",
            "It is very seldom that mere ordinary people like John and myself",
            "secure ancestral halls for the summer.",
            "A colonial mansion, a hereditary estate, I would say a haunted house,",
            "and reach the height of romantic felicity—",
            "but that would be asking too much of fate!",
            "Still I will proudly declare that there is something queer about it.",
            "Else, why should it be let so cheaply?",
            "And why have stood so long untenanted?",
            "John laughs at me, of course, but one expects that in marriage.",
            "John is practical in the extreme."
          ],
          [
            "Siddhartha by Hermann Hesse",
            "In the shade of the house, in the sunshine of the riverbank near the boats,",
            "in the shade of the Sal-wood forest,",
            "in the shade of the fig tree is where Siddhartha grew up,",
            "the handsome son of the Brahman,",
            "the young falcon, together with his friend Govinda,",
            "son of a Brahman.",
            "The sun tanned his light shoulders by the banks of the river",
            "when bathing, performing the sacred ablutions,",
            "the sacred offerings.",
            "In the mango grove, shade poured into his black eyes,",
            "when playing as a boy,"
          ]
        ]

        // Pick a random text
        const randomTextIndex = Math.floor(Math.random() * publicDomainTexts.length)
        const lines = publicDomainTexts[randomTextIndex]

        // Encrypt title first, then each line
        for (const line of lines) {
          const seq = demoState.senderContext.seq
          const plaintext = new TextEncoder().encode(line)

          // Generate random 8-byte AAD
          const aad = crypto.getRandomValues(new Uint8Array(8))
          const ciphertext = await demoState.senderContext.Seal(plaintext, aad)

          // Add encrypted message to chat
          addEncryptedMessage(seq, plaintext, ciphertext, aad)
        }

        // Update button states
        updateButtonStates()

        // Scroll to first decryptable message (seq === 0)
        const firstMessage = elements.chatContainer.querySelector('.chat-message[data-seq="0"]')
        if (firstMessage) {
          const offsetTop = firstMessage.offsetTop - elements.chatContainer.offsetTop - 15
          elements.chatContainer.scrollTo({ top: offsetTop, behavior: 'smooth' })
        }
      })

      // ============================================================================
      // TEST EXECUTION
      // ============================================================================

      /** Performs encryption/decryption test for regular AEAD modes */
      async function testRegularAEAD(suite, recipientKeyPair) {
        const plaintext = new TextEncoder().encode('Hello, HPKE!')
        const aad = new TextEncoder().encode('additional data')

        // Sender seals using recipient's public key
        const { encapsulatedKey, ciphertext } = await suite.Seal(
          recipientKeyPair.publicKey,
          plaintext,
        )

        // Recipient opens using their private key
        const decrypted = await suite.Open(recipientKeyPair, encapsulatedKey, ciphertext)

        // Verify decrypted matches plaintext
        const decryptedText = new TextDecoder().decode(decrypted)
        if (decryptedText !== 'Hello, HPKE!') {
          throw new Error(`Decryption mismatch: expected "Hello, HPKE!", got "${decryptedText}"`)
        }
      }

      /** Performs export-only mode test */
      async function testExportOnlyMode(suite, recipientKeyPair) {
        const exporterContext = new TextEncoder().encode('test context')
        const L = 32

        // Sender exports secret using recipient's public key
        const { encapsulatedKey, exportedSecret } = await suite.SendExport(
          recipientKeyPair.publicKey,
          exporterContext,
          L,
        )

        // Recipient receives exported secret using their private key
        const receivedSecret = await suite.ReceiveExport(
          recipientKeyPair,
          encapsulatedKey,
          exporterContext,
          L,
        )

        // Verify the secrets match
        assertUint8ArraysEqual(exportedSecret, receivedSecret, 'Exported secret mismatch')
      }

      /** Helper to find a matching implementation, preferring native over Noble */
      function findMatchingImplementation(algorithms, algorithmId, unsupportedList) {
        // Prefer native implementations that are supported
        return (
          algorithms.find((a) => {
            if (ALGORITHM_IDS[a.name] !== algorithmId) return false
            return !a.isNoble && !unsupportedList.includes(a.name)
          }) ||
          // Fall back to Noble implementation
          algorithms.find((a) => {
            if (ALGORITHM_IDS[a.name] !== algorithmId) return false
            return a.isNoble
          })
        )
      }

      /** Helper to verify two Uint8Arrays match */
      const assertUint8ArraysEqual = (actual, expected, errorPrefix) => {
        if (actual.length !== expected.length) throw new Error(`${errorPrefix}: length mismatch`)
        if (!actual.every((val, i) => val === expected[i])) throw new Error(`${errorPrefix}: content mismatch`)
      }

      /** Runs a single test for a KEM/KDF/AEAD combination */
      async function runTest(test) {
        test.status = 'running'
        renderAlgorithmSummary()

        try {
          // Test with baseline components (existing behavior)
          const suite = new HPKE.CipherSuite(test.kem.factory, test.kdf.factory, test.aead.factory)

          // Generate test key pair
          await suite.GenerateKeyPair()
          const ikm = crypto.getRandomValues(new Uint8Array(suite.KEM.Nsk))
          const keyPair = await suite.DeriveKeyPair(ikm, true)

          // Serialize and deserialize keys to test that functionality
          const serializedPublicKey = await suite.SerializePublicKey(keyPair.publicKey)
          const serializedPrivateKey = await suite.SerializePrivateKey(keyPair.privateKey)
          const recipientPrivateKey = await suite.DeserializePrivateKey(serializedPrivateKey, true)
          const recipientPublicKey = await suite.DeserializePublicKey(serializedPublicKey)
          const recipientKeyPair = {
            publicKey: recipientPublicKey,
            privateKey: recipientPrivateKey,
          }

          // Test based on AEAD mode
          if (test.aead.name === 'AEAD_EXPORT_ONLY') {
            await testExportOnlyMode(suite, recipientKeyPair)
          } else {
            await testRegularAEAD(suite, recipientKeyPair)
          }

          test.status = 'passed'
          test.error = null

          // Collect passing implementation
          const component = test.testingComponent
          const componentAlgo = test[component]
          const algoId = ALGORITHM_IDS[componentAlgo.name]

          if (algoId !== undefined) {
            if (!passingImplementations[component].has(algoId)) {
              passingImplementations[component].set(algoId, [])
            }
            passingImplementations[component].get(algoId).push({
              factory: componentAlgo.factory,
              isNoble: componentAlgo.isNoble,
            })
          }
        } catch (error) {
          test.status = 'failed'
          test.error = error.message || String(error)

          // Log unexpected failures to console
          if (!test.expectedToFail) {
            // console.error(`Unexpected failure: ${getTestDisplayName(test)}`, error)
          }
        }

        renderAlgorithmSummary()
      }

      /** Runs all tests */
      async function runAllTests() {
        // Prioritize baseline algorithms to enable demo section faster
        const priorityTests = tests.filter(t => {
          const component = getTestComponent(t)
          return (
            (t.testingComponent === 'kem' && component.name === 'KEM_DHKEM_P256_HKDF_SHA256') ||
            (t.testingComponent === 'kdf' && component.name === 'KDF_HKDF_SHA256') ||
            (t.testingComponent === 'aead' && component.name === 'AEAD_AES_128_GCM')
          )
        })
        const otherTests = tests.filter(t => !priorityTests.includes(t))

        // Run priority tests first
        for (const test of priorityTests) {
          await runTest(test)
          await new Promise((resolve) => setTimeout(resolve, 10))
        }

        // Then run remaining tests
        for (const test of otherTests) {
          await runTest(test)
          await new Promise((resolve) => setTimeout(resolve, 10))
        }

        // Expose results to globalThis after all tests complete
        updateGlobalResults()
      }

      // ============================================================================
      // RESULTS EXPORT
      // ============================================================================

      /** Exposes test results on globalThis for external access */
      function updateGlobalResults() {
        globalThis.hpkeTestResults = {
          total: tests.length,
          passed: tests.filter((t) => t.status === 'passed').length,
          failed: tests.filter((t) => t.status === 'failed').length,
          expectedFailures: tests.filter((t) => t.status === 'failed' && t.expectedToFail).length,
          unexpectedFailures: tests.filter((t) => t.status === 'failed' && !t.expectedToFail)
            .length,
          unexpectedPasses: tests.filter((t) => t.status === 'passed' && t.expectedToFail).length,
          tests: tests.map((t) => {
            const component = getTestComponent(t)
            return {
              id: t.id,
              component: t.testingComponent,
              name: component.displayName || component.name,
              suite: {
                kem: t.kem.displayName || t.kem.name,
                kdf: t.kdf.displayName || t.kdf.name,
                aead: t.aead.displayName || t.aead.name,
              },
              status: t.status,
              expectedToFail: t.expectedToFail,
              error: t.error,
            }
          }),
        }
      }

      // ============================================================================
      // INITIALIZATION
      // ============================================================================

      // ============================================================================
      // VECTOR VALIDATION
      // ============================================================================

      /** Runs comprehensive vector validation tests */
      async function runVectorValidation() {
        const progressInfo = document.getElementById('vectorProgressInfo')

        let completedOps = 0
        let passedOps = 0
        let failedOps = 0
        let totalOps = 0
        let lastFailedBox = -1

        // Calculate total operations first
        for (const vector of allVectors) {
          const kemImpls = passingImplementations.kem.get(vector.kem_id) || []
          const kdfImpls = passingImplementations.kdf.get(vector.kdf_id) || []
          const aeadImpls = passingImplementations.aead.get(vector.aead_id) || []

          if (!kemImpls.length || !kdfImpls.length || !aeadImpls.length) continue

          const combinations = kemImpls.length * kdfImpls.length * aeadImpls.length
          totalOps +=
            combinations * ((vector.encryptions?.length || 0) + (vector.exports?.length || 0))
        }

        if (totalOps === 0) {
          progressInfo.innerHTML =
            '<span>No functional implementations found for vector validation</span>'
          return
        }

        const updateProgress = () => {
          const percent = (completedOps / totalOps) * 100
          const filledBoxes = Math.floor(percent / 5)

          const boxes = document.querySelectorAll('.progress-box')
          boxes.forEach((box, index) => {
            const shouldBeFilled = index < filledBoxes
            const isFilled = box.classList.contains('filled')

            // Only modify classes if state changed
            if (shouldBeFilled && !isFilled) {
              box.classList.add('filled')
            } else if (!shouldBeFilled && isFilled) {
              box.classList.remove('filled', 'failed')
            }
          })

          // Mark the box corresponding to when the first failure occurred
          if (failedOps > 0 && lastFailedBox === -1) {
            lastFailedBox = Math.max(0, filledBoxes - 1)
          }
          if (lastFailedBox >= 0 && lastFailedBox < boxes.length) {
            const failedBox = boxes[lastFailedBox]
            if (!failedBox.classList.contains('failed')) {
              failedBox.classList.add('failed')
            }
          }

          progressInfo.innerHTML = `
            <span>Total: ${totalOps} operations</span>
            <span><span class="passed">✓ ${passedOps}</span> <span class="failed">✗ ${failedOps}</span></span>
          `
        }

        updateProgress()

        // Update progress every 50ms during execution
        const progressInterval = setInterval(() => updateProgress(), 50)

        // Cache for recipient key pairs: Map<kemImpl, Map<ikmR_hex, keyPair>>
        const recipientKeyPairCache = new Map()

        // Process all vectors with their implementations
        for (const vector of allVectors) {
          const kemImpls = passingImplementations.kem.get(vector.kem_id) || []
          const kdfImpls = passingImplementations.kdf.get(vector.kdf_id) || []
          const aeadImpls = passingImplementations.aead.get(vector.aead_id) || []

          if (!kemImpls.length || !kdfImpls.length || !aeadImpls.length) continue

          for (const kemImpl of kemImpls) {
            for (const kdfImpl of kdfImpls) {
              for (const aeadImpl of aeadImpls) {
                const suite = new HPKE.CipherSuite(
                  kemImpl.factory,
                  kdfImpl.factory,
                  aeadImpl.factory,
                )
                const ikmR = Uint8Array.fromHex(vector.ikmR)

                // Check cache for this kemImpl and ikmR combination
                if (!recipientKeyPairCache.has(kemImpl)) {
                  recipientKeyPairCache.set(kemImpl, new Map())
                }
                const kemCache = recipientKeyPairCache.get(kemImpl)

                let recipientKeyPair
                if (kemCache.has(vector.ikmR)) {
                  recipientKeyPair = kemCache.get(vector.ikmR)
                } else {
                  recipientKeyPair = await suite.DeriveKeyPair(ikmR, true)
                  kemCache.set(vector.ikmR, recipientKeyPair)
                }
                const enc = Uint8Array.fromHex(vector.enc)

                const options = {
                  info: Uint8Array.fromHex(vector.info),
                  psk: vector.psk ? Uint8Array.fromHex(vector.psk) : undefined,
                  pskId: vector.psk_id ? Uint8Array.fromHex(vector.psk_id) : undefined,
                }

                const ctx = await suite.SetupRecipient(recipientKeyPair, enc, options)

                // Test all encryptions
                if (vector.encryptions) {
                  for (const encryption of vector.encryptions) {
                    try {
                      const ciphertext = Uint8Array.fromHex(encryption.ct)
                      const aad = Uint8Array.fromHex(encryption.aad)
                      const expectedPlaintext = Uint8Array.fromHex(encryption.pt)
                      const decrypted = await ctx.Open(ciphertext, aad)
                      assertUint8ArraysEqual(decrypted, expectedPlaintext, 'Plaintext mismatch')
                      passedOps++
                    } catch (e) {
                      failedOps++
                    } finally {
                      completedOps++
                    }
                  }
                }

                // Test all exports
                if (vector.exports) {
                  for (const exportTest of vector.exports) {
                    try {
                      const exporterContext = Uint8Array.fromHex(exportTest.exporter_context)
                      const L = exportTest.L
                      const expectedExportedValue = Uint8Array.fromHex(exportTest.exported_value)
                      const exportedValue = await ctx.Export(exporterContext, L)
                      assertUint8ArraysEqual(
                        exportedValue,
                        expectedExportedValue,
                        'Export mismatch',
                      )
                      passedOps++
                    } catch (e) {
                      failedOps++
                    } finally {
                      completedOps++
                    }
                  }
                }

                updateProgress()
                // Yield to event loop to allow UI updates
                await new Promise((resolve) => setTimeout(resolve, 0))
              }
            }
          }
        }

        // Final update
        clearInterval(progressInterval)
        updateProgress()

        // Add vector results to globalThis
        globalThis.hpkeTestResults.vectorValidation = {
          total: totalOps,
          passed: passedOps,
          failed: failedOps,
        }
      }

      /** Initializes the test suite and starts execution */
      async function init() {
        const playOverlay = document.getElementById('playOverlay')

        tests = generateTests()
        renderAlgorithmSummary()

        // Run tests in background without blocking UI
        await runAllTests()

        // Show play button now that tests are complete
        playOverlay.classList.remove('hidden')

        // Helper function to copy text and show "Copied!" on button
        const copyWithFeedback = async (btn, text) => {
          try {
            await navigator.clipboard.writeText(text)
            btn.classList.add('copied')
            btn.textContent = 'Copied!'
            setTimeout(() => {
              btn.classList.remove('copied')
              btn.textContent = 'Copy'
            }, 1500)
          } catch (err) {
            console.error('Failed to copy:', err)
          }
        }

        // Set up copy button handlers
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation()
            const targetId = btn.dataset.copy
            const targetEl = document.getElementById(targetId)
            if (targetEl && !targetEl.classList.contains('placeholder')) {
              await copyWithFeedback(btn, targetEl.textContent)
            }
          })
        })

        // Set up click-to-copy on key display values
        document.querySelectorAll('.key-display-value').forEach(valueEl => {
          valueEl.addEventListener('click', async () => {
            if (valueEl.classList.contains('placeholder')) return
            // Find the associated copy button by matching data-copy attribute to this element's id
            const btn = document.querySelector(`.copy-btn[data-copy="${valueEl.id}"]`)
            if (btn) {
              await copyWithFeedback(btn, valueEl.textContent)
            }
          })
        })

        // Set up play button click handler
        document.getElementById('playOverlay').addEventListener('click', async () => {
          const overlay = document.getElementById('playOverlay')
          const content = document.getElementById('vectorValidationContent')

          // Remove overlay and blur
          overlay.classList.add('hidden')
          content.classList.remove('blurred')

          // Start validation
          await runVectorValidation()
        })

        // Auto-click play button in CI mode
        if (ci) {
          document.getElementById('playOverlay').click()
        }
      }

      init()
    </script>
  </body>
</html>
